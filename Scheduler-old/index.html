<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Line Dance Scheduler</title>

    <!-- STYLES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: #f1f5f9;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        .animate-fade-in {
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #startup-error {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #fff;
            z-index: 9999;
            padding: 2rem;
            color: #ef4444;
            font-family: monospace;
            overflow: auto;
        }

        /* --- Dark Neon Theme Overrides --- */
        body.dark-neon {
            /* Tweak colors to improve contrast for accessibility */
            --bg: #03040a; /* slightly darker */
            --bg-alt: #0b0f15; /* main page surface */
            --panel: #0f1724; /* panel color slightly lifted for contrast */
            --panel-alt: #16202b; /* alternate panel color */
            --panel-hover: #18232e; /* hover state */
            --border: #24303c; /* border on dark panels */
            --text: #edf2ff; /* brighter text for body */
            --text-dim: #9fb3c8; /* brighter dim text for better contrast */
            --accent-cyan: #00eaff;
            --accent-magenta: #ff00d4;
            --accent-lime: #8dff00;
            --danger: #ff4d4d;
            --gradient-accent: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta), var(--accent-lime));
            background: radial-gradient(circle at 20% 20%, #0a0f1c 0%, #05060a 60%);
            color: var(--text);
            min-height: 100vh;
        }

        /* Scrollbar updated for dark theme */
        body.dark-neon ::-webkit-scrollbar-track { background: #10131a; }
        body.dark-neon ::-webkit-scrollbar-thumb { background: #263042; }
        body.dark-neon ::-webkit-scrollbar-thumb:hover { background: #345068; }

        /* Common background utility overrides */
        body.dark-neon .bg-white { background-color: var(--panel) !important; }
        body.dark-neon .bg-gray-50,
        body.dark-neon .bg-slate-50,
        body.dark-neon .bg-gray-100 { background-color: var(--bg-alt) !important; }
        body.dark-neon .bg-indigo-700 { background: var(--gradient-accent) !important; }
        body.dark-neon .bg-indigo-600 { background: linear-gradient(135deg,#5200aa,#c800ff) !important; }
        body.dark-neon .bg-slate-900 { background-color: #02040a !important; }

        /* Text color utilities */
        body.dark-neon .text-slate-900,
        body.dark-neon .text-slate-800,
        body.dark-neon .text-slate-700 { color: var(--text) !important; }
        body.dark-neon .text-slate-600 { color: var(--text-dim) !important; }
        body.dark-neon .text-slate-500 { color: #b5c7d9 !important; }
        body.dark-neon .text-slate-400 { color: #9aaabf !important; }
        body.dark-neon .text-indigo-200 { color: #b6c9ff !important; }

        /* Borders */
        body.dark-neon .border-slate-200,
        body.dark-neon .border-slate-300 { border-color: var(--border) !important; }
        body.dark-neon .shadow-md,
        body.dark-neon .shadow-sm { box-shadow: 0 4px 12px -2px rgba(0,0,0,0.55), 0 0 0 1px rgba(0,234,255,0.05); }

        /* Interactive elements */
        body.dark-neon button,
        body.dark-neon input,
        body.dark-neon select,
        body.dark-neon textarea { background-color: var(--panel); color: var(--text); }
        body.dark-neon input::placeholder,
        body.dark-neon textarea::placeholder { color: #485264; }

        /* Make placeholders lighter in dark theme for accessibility */
        body.dark-neon input::placeholder, body.dark-neon textarea::placeholder { color: var(--text-dim) !important; opacity: 0.9; }
        body.dark-neon input:focus,
        body.dark-neon select:focus,
        body.dark-neon textarea:focus { outline: none; border-color: var(--accent-cyan) !important; box-shadow: 0 0 0 1px var(--accent-cyan), 0 0 8px 2px rgba(0,234,255,0.35), 0 0 18px -2px rgba(255,0,212,0.4); }

        body.dark-neon .hover\:bg-indigo-700:hover,
        body.dark-neon .hover\:bg-indigo-600:hover { filter: brightness(1.15) saturate(1.2); }
        body.dark-neon .hover\:bg-slate-200:hover { background-color: var(--panel-hover) !important; }

        /* Badges (difficulty colors) */
        body.dark-neon .bg-green-100 { background-color: rgba(0,234,255,0.12) !important; color: var(--accent-cyan) !important; }
        body.dark-neon .bg-blue-100 { background-color: rgba(255,0,212,0.12) !important; color: var(--accent-magenta) !important; }
        body.dark-neon .bg-orange-100 { background-color: rgba(141,255,0,0.12) !important; color: var(--accent-lime) !important; }
        body.dark-neon .bg-red-100 { background-color: rgba(255,77,77,0.12) !important; color: var(--danger) !important; }

        /* Links */
        body.dark-neon a { color: var(--accent-cyan); }
        body.dark-neon a:hover { color: var(--accent-magenta); }

        /* Loader accent */
        body.dark-neon .text-indigo-600 { color: var(--accent-cyan) !important; }
        body.dark-neon .animate-spin { color: var(--accent-magenta) !important; }

        /* Footer */
        body.dark-neon footer { background: #02040a !important; border-top: 1px solid var(--border); }

        /* Startup error in dark mode */
        body.dark-neon #startup-error { background: #141a22; color: var(--danger); }
        body.dark-neon #startup-error h2 { color: var(--danger); }

        /* Admin auth overlay accessibility overrides */
        body.dark-neon #admin-auth-overlay { color: var(--text) !important; }
        body.dark-neon #admin-auth-overlay h3 { color: var(--text) !important; }
        body.dark-neon #admin-auth-overlay p { color: var(--text-dim) !important; }
        body.dark-neon #admin-auth-overlay input { color: var(--text) !important; background-color: var(--panel) !important; border-color: var(--border) !important; }
        body.dark-neon #admin-auth-overlay input::placeholder { color: rgba(255,255,255,0.62) !important; }
        body.dark-neon #admin-auth-overlay .text-slate-500 { color: var(--text-dim) !important; }

        /* Subtle neon edge glow for panels */
        body.dark-neon .rounded-lg,
        body.dark-neon .rounded,
        body.dark-neon .rounded-full { position: relative; }
        body.dark-neon .rounded-lg::after,
        body.dark-neon .rounded::after { content:""; pointer-events:none; position:absolute; inset:0; border-radius:inherit; box-shadow:0 0 0 1px rgba(0,234,255,0.15),0 0 12px -2px rgba(255,0,212,0.35); }

        /* Header subtle glow */
        body.dark-neon header { box-shadow: 0 0 0 1px rgba(0,234,255,0.25), 0 4px 18px -2px rgba(255,0,212,0.35); }

        /* Selection color */
        body.dark-neon ::selection { background: rgba(0,234,255,0.35); color: #fff; }
    </style>
    </style>

    <!-- DEPENDENCIES -->
    <!-- React & ReactDOM (UMD) -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

    <!-- Babel for in-browser compilation -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <!-- Date Fns (UMD) -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>

    <!-- Lucide Icons (Vanilla - Most Stable for CDN usage) -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/",
    "firebase/": "https://aistudiocdn.com/firebase@^12.6.0/",
    "lucide-react": "https://aistudiocdn.com/lucide-react@^0.554.0",
    "date-fns": "https://aistudiocdn.com/date-fns@^4.1.0"
  }
}
</script>
</head>

<body class="dark-neon">

    <div id="root">
        <div class="flex items-center justify-center min-h-screen text-slate-400">
            <svg class="animate-spin h-8 w-8 mr-3 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <span class="font-medium">Loading application...</span>
        </div>
    </div>

    <div id="startup-error">
        <h2 class="text-xl font-bold mb-4 text-slate-900">Startup Error</h2>
        <div id="error-message" class="bg-red-50 p-4 rounded border border-red-200 whitespace-pre-wrap"></div>
        <p class="mt-4 text-slate-600 text-sm">Please check your internet connection or try reloading.</p>
    </div>

    <script>
        window.onerror = function (message, source, lineno, colno, error) {
            document.getElementById('root').style.display = 'none';
            document.getElementById('startup-error').style.display = 'block';
            document.getElementById('error-message').textContent = "Error: " + message + "\nLine: " + lineno;
        };
    </script>

    <script type="text/babel" data-presets="react,typescript">
        try {
            /************************************************************
             * 1. GLOBAL IMPORTS & CHECKS
             ************************************************************/
            const { useState, useEffect, useMemo, useRef } = React;

            // Check Libraries
            if (!window.dateFns) throw new Error("date-fns not loaded.");
            const { format, getDay, getDaysInMonth, isSameDay, addMonths } = window.dateFns;

            // --- CUSTOM LUCIDE ADAPTER ---
            const Lucide = new Proxy({}, {
                get: (target, prop) => {
                    const iconName = prop;
                    const iconData = window.lucide && window.lucide.icons ? window.lucide.icons[iconName] : null;

                    return (props) => {
                        if (!iconData) {
                            console.warn(`Icon "${iconName}" not found in Lucide library.`);
                            return React.createElement('svg', { ...props, width: 24, height: 24, viewBox: "0 0 24 24", fill: "none", stroke: "currentColor", strokeWidth: 2 },
                                React.createElement('rect', { x: 3, y: 3, width: 18, height: 18, rx: 2 })
                            );
                        }

                        return React.createElement('svg', {
                            xmlns: "http://www.w3.org/2000/svg",
                            width: props.size || 24,
                            height: props.size || 24,
                            viewBox: "0 0 24 24",
                            fill: "none",
                            stroke: props.color || "currentColor",
                            strokeWidth: props.strokeWidth || 2,
                            strokeLinecap: "round",
                            strokeLinejoin: "round",
                            className: props.className,
                            style: props.style,
                            ...props
                        },
                            iconData.map((child, index) => {
                                const [tagName, attrs] = child;
                                return React.createElement(tagName, { ...attrs, key: index });
                            }));
                    };
                }
            });

            const {
                Music, Calendar, LogOut, Check, X, Save, Search, Plus,
                Link: LinkIcon, ListMusic, ArrowRight, Wand2, Trash2,
                AlertCircle, Download, GripVertical, User, RefreshCcw,
                CheckCircle, XCircle, UserCircle, ShieldCheck, Loader2, ArrowLeft, AlertTriangle, Settings
            } = Lucide;

            // FIX: Alias Calendar to CalIcon as used in AdminDashboard
            const CalIcon = Calendar;

            /************************************************************
             * 2. TYPES & ENUMS
             ************************************************************/
            const Difficulty = {
                Beginner: 1,
                HighBeginner: 2,
                Improver: 3,
                HighImprover: 4,
                LowIntermediate: 5,
                Intermediate: 6,
                HighIntermediate: 7,
                Advanced: 8
            };

            const TIME_SLOTS = ["7:30 PM", "8:15 PM"];

            const getDifficultyLabel = (diff) => {
                switch (diff) {
                    case Difficulty.Beginner: return 'Beginner';
                    case Difficulty.HighBeginner: return 'High Beginner';
                    case Difficulty.Improver: return 'Improver';
                    case Difficulty.HighImprover: return 'High Improver';
                    case Difficulty.LowIntermediate: return 'Low Intermediate';
                    case Difficulty.Intermediate: return 'Intermediate';
                    case Difficulty.HighIntermediate: return 'High Intermediate';
                    case Difficulty.Advanced: return 'Advanced';
                    default: return 'Unknown';
                }
            };

            const getDifficultyColor = (diff) => {
                if (diff <= 2) return 'bg-green-100 text-green-800';
                if (diff <= 4) return 'bg-blue-100 text-blue-800';
                if (diff <= 6) return 'bg-orange-100 text-orange-800';
                return 'bg-red-100 text-red-800';
            };

            // --- HELPERS FOR DATE NORMALIZATION ---
            const normalizeDate = (d) => d.includes('T') ? d.split('T')[0] : d;
            const parseYMD = (ymd) => {
                const [y, m, d] = ymd.split('-').map(Number);
                return new Date(y, m - 1, d);
            };

            /************************************************************
             * 3. SERVICES (GAS BRIDGE)
             ************************************************************/
            const runGAS = (funcName, ...args) => {
                return new Promise((resolve, reject) => {
                    if (typeof window !== 'undefined' && window.google && window.google.script) {
                        window.google.script.run
                            .withSuccessHandler(resolve)
                            .withFailureHandler(reject)
                        [funcName](...args);
                    } else {
                        console.warn(`[DEV] GAS not found. Function ${funcName} called.`);
                        if (funcName === 'getInstructors') resolve([{ id: 'demo', name: 'Demo Instructor' }]);
                        else if (funcName === 'getDances') resolve([]);
                        else if (funcName.startsWith('get')) resolve([]);
                        else resolve({});
                    }
                });
            };

            const StorageService = {
                getInstructors: () => runGAS('getInstructors'),
                saveAvailability: (avail) => runGAS('saveAvailability', avail),
                getAvailability: (m, y) => runGAS('getAvailability', m, y),
                // FIX: Stringify payload on client to ensure JSON key order is preserved during transport
                saveDaySchedule: (s) => runGAS('saveDaySchedule', JSON.stringify(s)),
                deleteDaySchedule: (date) => runGAS('deleteDaySchedule', date),
                getMonthSchedule: (m, y) => runGAS('getMonthSchedule', m, y),
                getDances: () => runGAS('getDances'),
                addDance: (d) => runGAS('addDance', d),
                clearScheduleForMonth: (m, y) => runGAS('clearScheduleForMonth', m, y)
            };

            // New batched APIs
            StorageService.getMonthData = (m, y) => runGAS('getMonthData', m, y);
            StorageService.batchSaveDaySchedules = (arr) => runGAS('batchSaveDaySchedules', JSON.stringify(arr));
            StorageService.batchDeleteDaySchedules = (arr) => runGAS('batchDeleteDaySchedules', JSON.stringify(arr));

            /************************************************************
             * 4. COMPONENTS
             ************************************************************/

            /* --- Layout --- */
            const Layout = ({ children, title, onLogout, user }) => {
                return (
                    <div className="min-h-screen bg-slate-50 flex flex-col font-sans">
                        <header className="bg-indigo-700 text-white shadow-md sticky top-0 z-50">
                            <div className="max-w-6xl mx-auto px-4 h-16 flex items-center justify-between">
                                <div className="flex items-center space-x-3">
                                    <div className="p-2 bg-white/10 rounded-full">
                                        <Music size={20} className="text-indigo-100" />
                                    </div>
                                    <div>
                                        <h1 className="text-lg font-bold leading-tight">Line Dance Scheduler</h1>
                                        <p className="text-xs text-indigo-200">Neon Boots Lesson Planning</p>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <span className="text-sm font-medium hidden sm:block bg-indigo-800/50 px-3 py-1 rounded-full border border-indigo-600/50">{title}</span>
                                    {user && (
                                        <div className="flex items-center space-x-2">
                                            <span className="text-xs text-indigo-200">Hi, {user}</span>
                                            <button onClick={onLogout} className="p-2 hover:bg-white/10 rounded-full transition-colors" title="Logout">
                                                <LogOut size={18} />
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </header>
                        <main className="flex-grow max-w-6xl w-full mx-auto p-4 md:p-6">{children}</main>
                        <footer className="bg-slate-900 text-slate-400 py-6 mt-auto">
                            <div className="max-w-6xl mx-auto px-4 text-center text-sm">
                                <p>© 2025.</p>
                            </div>
                        </footer>
                    </div>
                );
            };

            /* --- DanceSelector --- */
            const DanceSelector = ({ dancesDatabase, selectedDances, onChange, onAddNew }) => {
                const [searchTerm, setSearchTerm] = useState('');
                const [isDropdownOpen, setIsDropdownOpen] = useState(false);
                const [showAddForm, setShowAddForm] = useState(false);
                const [newDance, setNewDance] = useState({ stepsheetUrl: '', name: '', song: '', artist: '', difficulty: Difficulty.Beginner });
                const inputRef = useRef(null);
                const dropdownRef = useRef(null);
                const [dropdownStyle, setDropdownStyle] = useState(null);

                const db = Array.isArray(dancesDatabase) ? dancesDatabase : [];
                const selectedIds = useMemo(() => new Set((selectedDances || []).map(s => s.id)), [selectedDances]);
                const maxResults = 200; // keep it reasonable for performance
                const term = (searchTerm || '').toLowerCase().trim();

                const filteredDances = useMemo(() => {
                    if (!db || db.length === 0) return [];
                    const matches = [];
                    if (!term) {
                        // No search term: show the alphabetically sorted list of available dances
                        for (const d of db) {
                            if (selectedIds.has(d.id)) continue;
                            matches.push(d);
                        }
                        return matches.sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''))).slice(0, maxResults);
                    }

                    for (const d of db) {
                        if (selectedIds.has(d.id)) continue;
                        const name = String(d.name || '').toLowerCase();
                        const artist = String(d.artist || '').toLowerCase();
                        const song = String(d.song || '').toLowerCase();
                        if (name.includes(term) || artist.includes(term) || song.includes(term)) {
                            matches.push(d);
                        }
                    }
                    return matches.sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''))).slice(0, Math.min(matches.length, maxResults));
                }, [db, selectedIds, term]);

                const addDance = (dance) => { onChange([...selectedDances, dance]); setSearchTerm(''); setIsDropdownOpen(false); };
                const removeDance = (id) => { onChange(selectedDances.filter(d => d.id !== id)); };

                const handleCreateDance = (e) => {
                    e.preventDefault();
                    if (!newDance.name || !newDance.artist) return;
                    const dance = { id: `custom-${Date.now()}`, name: newDance.name, song: newDance.song || '', artist: newDance.artist, difficulty: newDance.difficulty };
                    if (newDance.stepsheetUrl) dance.stepsheetUrl = newDance.stepsheetUrl;
                    onAddNew(dance); addDance(dance); setShowAddForm(false); setNewDance({ stepsheetUrl: '', name: '', song: '', artist: '', difficulty: Difficulty.Beginner });
                };

                // Compute and update dropdown style (positioning) to anchor it to the input
                useEffect(() => {
                    if (!isDropdownOpen) {
                        setDropdownStyle(null);
                        return;
                    }
                    const update = () => {
                        if (!inputRef.current) return;
                        const r = inputRef.current.getBoundingClientRect();
                        const padding = 8;
                        const leftRaw = r.left;
                        const width = Math.max(r.width, 200);
                        let left = leftRaw;
                        // Clamp so dropdown doesn't overflow viewport
                        if (left + width + padding > window.innerWidth) {
                            left = Math.max(padding, window.innerWidth - width - padding);
                        }
                        const top = r.bottom + 6; // small gap below input
                        // calculate available space below, and cap the height
                        const bottomSpace = window.innerHeight - r.bottom;
                        const maxHeight = Math.max(80, Math.min(300, bottomSpace - 16));
                        setDropdownStyle({ position: 'fixed', top: `${top}px`, left: `${left}px`, width: `${width}px`, maxHeight: `${maxHeight}px`, overflowY: 'auto' });
                    };
                    update();
                    window.addEventListener('resize', update);
                    window.addEventListener('scroll', update, true);
                    // Also try to reposition if keyboard opens (via resize delay)
                    const t = setInterval(update, 250);
                    return () => { window.removeEventListener('resize', update); window.removeEventListener('scroll', update, true); clearInterval(t); };
                }, [isDropdownOpen, searchTerm]);

                // Close dropdown when clicking outside
                useEffect(() => {
                    const handler = (e) => {
                        if (!isDropdownOpen) return;
                        const target = e.target;
                        if (inputRef.current && inputRef.current.contains(target)) return;
                        if (dropdownRef.current && dropdownRef.current.contains(target)) return;
                        setIsDropdownOpen(false);
                    };
                    document.addEventListener('mousedown', handler);
                    return () => document.removeEventListener('mousedown', handler);
                }, [isDropdownOpen]);

                return (
                    <div className="w-full">
                        <div className="flex flex-wrap gap-3 mb-3">
                            {selectedDances.map((dance) => (
                                <div key={dance.id} className="flex items-center bg-white border border-indigo-200 rounded-lg p-2 pr-3 shadow-sm">
                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center text-xs font-bold mr-3 ${getDifficultyColor(dance.difficulty)}`}>L{dance.difficulty}</div>
                                    <div className="mr-3"><div className="text-sm font-semibold text-slate-800">{dance.name}</div><div className="text-xs text-slate-500">{dance.artist}</div></div>
                                    <button onClick={() => removeDance(dance.id)} className="text-slate-400 hover:text-red-500"><X size={16} /></button>
                                </div>
                            ))}
                            {!showAddForm && (
                                <div className="relative inline-block min-w-[250px] flex-grow">
                                    <div className="flex items-center border border-slate-300 rounded-lg px-3 py-2 bg-white focus-within:border-indigo-500 ring-0">
                                        <Search size={18} className="text-slate-400 mr-2" />
                                        <input ref={inputRef} type="text" className="outline-none text-sm w-full" placeholder="Add dance..." value={searchTerm} onChange={e => { setSearchTerm(e.target.value); setIsDropdownOpen(true); }} onFocus={() => setIsDropdownOpen(true)} />
                                    </div>
                                    {isDropdownOpen && (
                                        <div
                                            className="fixed z-50 bg-white border border-slate-200 rounded-lg shadow-lg max-h-60 overflow-y-auto"
                                            style={dropdownStyle ? dropdownStyle : { visibility: 'hidden' }}
                                            ref={dropdownRef}
                                            onMouseDown={(e) => e.preventDefault()} // prevent input blur on click
                                        >
                                            {filteredDances.length > 0 ? filteredDances.map(d => (
                                                <button key={d.id} onClick={() => addDance(d)} className="w-full text-left px-4 py-2 hover:bg-indigo-50 flex items-center text-sm">
                                                    <span className={`w-2 h-2 rounded-full mr-2 ${getDifficultyColor(d.difficulty)}`}></span>
                                                    <span className="font-medium mr-1">{d.name}</span>
                                                    <span className="text-slate-400">- {d.artist}</span>
                                                </button>
                                            )) : (searchTerm && <div className="px-4 py-2 text-xs text-slate-400 italic">No dances found</div>)}
                                            <button onClick={() => setShowAddForm(true)} className="w-full text-left px-4 py-2 bg-slate-50 text-indigo-600 hover:bg-indigo-50 text-sm font-medium border-t border-slate-100 flex items-center">
                                                <Plus size={14} className="mr-2" /> Create "{searchTerm}"
                                            </button>
                                        </div>
                                    )}
                                </div>
                            )}
                        </div>
                        {showAddForm && (
                            <form onSubmit={handleCreateDance} className="mt-4 p-4 bg-slate-50 rounded-lg border border-slate-200">
                                <h4 className="text-sm font-bold text-slate-700 mb-3">Add New Dance</h4>
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-4 mb-4">
                                    <div className="col-span-1 md:col-span-2">
                                        <label className="block text-xs font-semibold text-slate-500 mb-1">Stepsheet URL</label>
                                        <div className="flex items-center bg-white border border-slate-300 rounded-lg px-3 py-2 focus-within:border-indigo-500 transition-colors">
                                            <LinkIcon size={16} className="text-slate-400 mr-2 flex-shrink-0" />
                                            <input type="url" className="flex-1 outline-none text-sm min-w-0 bg-transparent" placeholder="https://..." value={newDance.stepsheetUrl} onChange={e => setNewDance({ ...newDance, stepsheetUrl: e.target.value })} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 mb-1">Dance Name</label>
                                        <input type="text" required className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none" placeholder="e.g. Electric Slide" value={newDance.name} onChange={e => setNewDance({ ...newDance, name: e.target.value })} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 mb-1">Song Title</label>
                                        <div className="flex items-center bg-white border border-slate-300 rounded-lg px-3 py-2 focus-within:border-indigo-500 transition-colors">
                                            <Music size={16} className="text-slate-400 mr-2 flex-shrink-0" />
                                            <input type="text" className="flex-1 outline-none text-sm min-w-0 bg-transparent" placeholder="e.g. Electric Boogie" value={newDance.song} onChange={e => setNewDance({ ...newDance, song: e.target.value })} />
                                        </div>
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 mb-1">Artist</label>
                                        <input type="text" required className="w-full border border-slate-300 rounded-lg px-3 py-2 text-sm focus:border-indigo-500 outline-none" placeholder="e.g. Marcia Griffiths" value={newDance.artist} onChange={e => setNewDance({ ...newDance, artist: e.target.value })} />
                                    </div>
                                    <div>
                                        <label className="block text-xs font-semibold text-slate-500 mb-1">Difficulty Level</label>
                                        <div className="relative">
                                            <select className="w-full appearance-none border border-slate-300 rounded-lg px-3 py-2 text-sm bg-white focus:border-indigo-500 outline-none" value={newDance.difficulty} onChange={e => setNewDance({ ...newDance, difficulty: parseInt(e.target.value) })}>
                                                {Object.values(Difficulty).filter(v => typeof v === 'number').map(v => <option key={v} value={v}>{getDifficultyLabel(v)}</option>)}
                                            </select>
                                            <div className="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500">
                                                <svg className="fill-current h-4 w-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20"><path d="M9.293 12.95l.707.707L15.657 8l-1.414-1.414L10 10.828 5.757 6.586 4.343 8z" /></svg>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div className="flex justify-end space-x-2"><button type="button" onClick={() => setShowAddForm(false)} className="px-4 py-2 text-sm text-slate-600 hover:bg-slate-200 rounded-lg">Cancel</button><button type="submit" className="px-4 py-2 text-sm bg-indigo-600 text-white hover:bg-indigo-700 rounded-lg">Add & Select</button></div>
                            </form>
                        )}
                    </div>
                );
            };

            /* --- AdminGlobalSearch --- */
            const AdminGlobalSearch = ({ allDances, scheduledDanceIds, onSelect, onTermChange }) => {
                const [term, setTerm] = useState('');
                const [isOpen, setIsOpen] = useState(false);
                const inputRef = useRef(null);
                const dropdownRef = useRef(null);
                const [dropdownStyle, setDropdownStyle] = useState(null);
                const db = Array.isArray(allDances) ? allDances : [];
                const selectedIds = scheduledDanceIds || new Set();
                const t = (term || '').toLowerCase().trim();

                const results = useMemo(() => {
                    if (!db || db.length === 0) return [];
                    const matches = [];
                    if (!t) {
                        for (const d of db) {
                            if (selectedIds.has(d.id)) continue;
                            matches.push(d);
                        }
                        return matches.sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''))).slice(0, 100);
                    }
                    for (const d of db) {
                        if (selectedIds.has(d.id)) continue;
                        const name = String(d.name || '').toLowerCase();
                        const artist = String(d.artist || '').toLowerCase();
                        const song = String(d.song || '').toLowerCase();
                        if (name.includes(t) || artist.includes(t) || song.includes(t)) matches.push(d);
                    }
                    return matches.sort((a, b) => String(a.name || '').localeCompare(String(b.name || ''))).slice(0, 100);
                }, [db, selectedIds, t]);

                useEffect(() => {
                    if (!isOpen) { setDropdownStyle(null); return; }
                    const update = () => {
                        if (!inputRef.current) return;
                        const r = inputRef.current.getBoundingClientRect();
                        const padding = 8;
                        const leftRaw = r.left;
                        const width = Math.max(r.width, 180);
                        let left = leftRaw;
                        if (left + width + padding > window.innerWidth) left = Math.max(padding, window.innerWidth - width - padding);
                        const top = r.bottom + 6;
                        const bottomSpace = window.innerHeight - r.bottom;
                        const maxHeight = Math.max(80, Math.min(300, bottomSpace - 16));
                        setDropdownStyle({ position: 'fixed', top: `${top}px`, left: `${left}px`, width: `${width}px`, maxHeight: `${maxHeight}px`, overflowY: 'auto' });
                    };
                    update();
                    window.addEventListener('resize', update);
                    window.addEventListener('scroll', update, true);
                    if (window.visualViewport) window.visualViewport.addEventListener('resize', update);
                    const tId = setInterval(update, 250);
                    return () => { window.removeEventListener('resize', update); window.removeEventListener('scroll', update, true); if (window.visualViewport) window.visualViewport.removeEventListener('resize', update); clearInterval(tId); };
                }, [isOpen, term]);

                useEffect(() => {
                    const handler = (e) => {
                        if (!isOpen) return;
                        const t = e.target;
                        if (inputRef.current && inputRef.current.contains(t)) return;
                        if (dropdownRef.current && dropdownRef.current.contains(t)) return;
                        setIsOpen(false);
                    };
                    document.addEventListener('mousedown', handler);
                    return () => document.removeEventListener('mousedown', handler);
                }, [isOpen]);

                return (
                    <div className="mt-2">
                        <div className="flex items-center bg-white border border-slate-200 rounded px-2 py-1">
                            <Search size={12} className="text-slate-400 mr-2" />
                            <input ref={inputRef} value={term} onChange={(e) => { const v = e.target.value; setTerm(v); setIsOpen(true); if (onTermChange) onTermChange(v); }} onFocus={() => setIsOpen(true)} placeholder="Search..." className="text-xs outline-none w-full bg-transparent" />
                        </div>
                        {isOpen && (
                            <div className="fixed z-50 bg-white border border-slate-200 rounded-lg shadow-lg max-h-80 overflow-y-auto" style={dropdownStyle ? dropdownStyle : { visibility: 'hidden' }} ref={dropdownRef} onMouseDown={(e)=> e.preventDefault()}>
                                {results.length > 0 ? results.map(d => (
                                    <div key={d.id} className="flex items-center justify-between px-3 py-2 text-xs hover:bg-indigo-50">
                                        <div className="truncate pr-2">
                                            <div className="font-medium truncate">{d.name}</div>
                                            <div className="text-[10px] text-slate-400 truncate">{d.artist}{d.song ? ` — ${d.song}` : ''}</div>
                                        </div>
                                        <button onClick={() => { onSelect(d); setIsOpen(false); setTerm(''); if (onTermChange) onTermChange(''); }} className="text-xs text-indigo-500 ml-2 px-2 py-1 rounded hover:bg-slate-50">Add</button>
                                    </div>
                                )) : (
                                    <div className="px-4 py-2 text-xs text-slate-400">No dances found</div>
                                )}
                            </div>
                        )}
                    </div>
                );
            };

            /* --- InstructorPortal --- */
            const InstructorPortal = ({ instructor, month }) => {
                const [activeDays, setActiveDays] = useState([]);
                const [availableDates, setAvailableDates] = useState([]);
                const [monthlyDances, setMonthlyDances] = useState([]);
                const [isSaving, setIsSaving] = useState(false);
                const [savedSuccess, setSavedSuccess] = useState(false);
                const [dances, setDances] = useState([]);
                const [activeTab, setActiveTab] = useState('availability');

                useEffect(() => {
                    const loadData = async () => {
                        try {
                            const data = await StorageService.getMonthData(month.getMonth(), month.getFullYear());
                            const avail = data?.availability || [];
                            const existingSchedules = data?.schedules || [];
                            const allDances = data?.dances || [];
                            setDances(allDances || []);

                            if (existingSchedules && existingSchedules.length > 0) {
                                const dbDates = existingSchedules
                                    .filter(s => !s.isHoliday)
                                    .map(s => normalizeDate(s.date))
                                    .sort();
                                setActiveDays(dbDates);
                            } else {
                                setActiveDays([]);
                            }

                            const availArray = Array.isArray(avail) ? avail : [];
                            const myAvail = availArray.find(a => a.instructorId === instructor.id);

                            if (myAvail) {
                                setAvailableDates(myAvail.availableDates || []);
                                if (myAvail.selectedDances?.length > 0) {
                                    setMonthlyDances(myAvail.selectedDances);
                                } else {
                                    const schedArray = Array.isArray(existingSchedules) ? existingSchedules : [];
                                    const mySchedules = schedArray.flatMap(day => day.lessons || []).filter(l => l.instructorId === instructor.id);
                                    if (mySchedules.length > 0) {
                                        const danceMap = new Map();
                                        mySchedules.forEach(l => {
                                            if (!danceMap.has(l.danceId)) {
                                                const fullDance = (allDances || []).find(d => d.id === l.danceId) || { id: l.danceId, name: l.danceName, difficulty: l.difficulty, artist: 'Unknown' };
                                                danceMap.set(l.danceId, fullDance);
                                            }
                                        });
                                        setMonthlyDances(Array.from(danceMap.values()));
                                    }
                                }
                            }
                        } catch (error) { console.error("Portal Data Error:", error); }
                    };
                    loadData();
                }, [month, instructor.id]);

                const toggleAvailability = (dateStr) => {
                    setAvailableDates(prev => prev.includes(dateStr) ? prev.filter(d => d !== dateStr) : [...prev, dateStr]);
                };

                const handleAddDanceToDb = async (newDance) => {
                    try { await StorageService.addDance(newDance); setDances(prev => [...prev, newDance]); } catch (err) { alert("Could not save dance."); }
                };

                const handleSave = async () => {
                    if (availableDates.length > 0 && monthlyDances.length === 0) { alert("Since you are available to teach, please select at least one dance you are prepared for."); return; }
                    setIsSaving(true);
                    try {
                        const toSave = [];
                        await StorageService.saveAvailability({ instructorId: instructor.id, month: month.getMonth(), year: month.getFullYear(), availableDates, selectedDances: monthlyDances });
                        setSavedSuccess(true); setTimeout(() => setSavedSuccess(false), 3000);
                    } catch (err) { alert("Failed to save"); } finally { setIsSaving(false); }
                };

                return (
                    <div className="space-y-6 animate-fade-in">
                        <div className="flex space-x-1 bg-white p-1 rounded-xl border border-slate-200 shadow-sm max-w-md">
                            <button onClick={() => setActiveTab('availability')} className={`flex-1 flex items-center justify-center py-2 text-sm font-medium rounded-lg transition-all ${activeTab === 'availability' ? 'bg-indigo-100 text-indigo-700 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}><Calendar size={16} className="mr-2" /> Availability</button>
                            <button onClick={() => setActiveTab('planning')} className={`flex-1 flex items-center justify-center py-2 text-sm font-medium rounded-lg transition-all ${activeTab === 'planning' ? 'bg-indigo-100 text-indigo-700 shadow-sm' : 'text-slate-500 hover:bg-slate-50'}`}><ListMusic size={16} className="mr-2" /> Preferences</button>
                        </div>

                        <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-4 md:p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold text-slate-800">{activeTab === 'availability' ? 'When can you teach?' : 'What can you teach?'}</h2>
                                {savedSuccess && <span className="text-green-600 font-medium flex items-center bg-green-50 px-3 py-1 rounded-full"><Check size={16} className="mr-1" /> Submitted</span>}
                            </div>

                            {activeTab === 'availability' && (
                                <div className="space-y-4">
                                    <p className="text-slate-500 mb-4">
                                        Select the dates you are available to teach this month.
                                        {activeDays.length === 0 && <span className="text-orange-500 ml-1 font-bold">No class dates have been scheduled by the admin yet.</span>}
                                    </p>
                                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                                        {activeDays.map((dateStr) => {
                                            const displayDate = parseYMD(dateStr);
                                            const isAvailable = availableDates.includes(dateStr);
                                            return (
                                                <button key={dateStr} onClick={() => toggleAvailability(dateStr)} className={`p-4 rounded-xl border-2 transition-all flex items-center justify-center sm:justify-between ${isAvailable ? 'border-indigo-600 bg-indigo-50' : 'border-slate-100 bg-white hover:border-slate-200'}`}>
                                                    <div className="text-left"><div className="font-bold text-lg text-slate-700">{format(displayDate, 'MMMM d')}</div><div className="text-sm text-slate-500">{format(displayDate, 'EEEE')}</div></div>
                                                    <div className={`w-8 h-8 rounded-full flex items-center justify-center ml-4 ${isAvailable ? 'bg-indigo-600 text-white' : 'bg-slate-200 text-slate-400'}`}>{isAvailable ? <Check size={20} /> : <X size={20} />}</div>
                                                </button>
                                            );
                                        })}
                                    </div>
                                    {activeDays.length > 0 && (
                                        <div className="flex justify-end mt-6"><button onClick={() => setActiveTab('planning')} className="flex items-center bg-indigo-600 text-white px-6 py-2 rounded-lg hover:bg-indigo-700 transition-colors">Next: Select Dances <ArrowRight size={16} className="ml-2" /></button></div>
                                    )}
                                </div>
                            )}

                            {activeTab === 'planning' && (
                                <div className="space-y-8">
                                    {availableDates.length === 0 && <div className="bg-orange-50 border border-orange-200 rounded-lg p-4 flex items-center text-orange-700 text-sm mb-4"><div className="mr-3 p-2 bg-orange-100 rounded-full"><Calendar size={16} /></div><div><strong>No dates selected.</strong> You can click submit below to confirm you are unavailable this month.</div></div>}
                                    <div className="border border-indigo-100 rounded-xl p-6 bg-indigo-50/30">
                                        <h3 className="font-semibold text-indigo-900 mb-2">Dance Repertoire for {format(month, 'MMMM')}</h3>
                                        <div className="bg-white p-4 rounded-xl border border-indigo-100 shadow-sm"><DanceSelector dancesDatabase={dances} selectedDances={monthlyDances} onChange={setMonthlyDances} onAddNew={handleAddDanceToDb} /></div>
                                    </div>
                                    <div className="mt-8 flex flex-col items-end border-t pt-4">
                                        <button onClick={handleSave} disabled={isSaving} className="flex items-center space-x-2 bg-slate-900 text-white px-8 py-3 rounded-full shadow-lg hover:bg-slate-800 transform hover:scale-105 transition-all disabled:opacity-50">
                                            {isSaving ? <div className="w-5 h-5 border-2 border-white/30 border-t-white rounded-full animate-spin"></div> : <Save size={20} />}<span className="font-semibold">{availableDates.length === 0 ? "Confirm Unavailable (Busy)" : "Submit Availability & Preferences"}</span>
                                        </button>
                                    </div>
                                </div>
                            )}
                        </div>
                    </div>
                );
            };

            /* --- AdminDashboard --- */
            const AdminDashboard = ({ month, instructors }) => {
                const [schedules, setSchedules] = useState([]);
                const [availabilities, setAvailabilities] = useState([]);
                const [allDances, setAllDances] = useState([]);

                const [activeDates, setActiveDates] = useState([]);

                const [selectedDate, setSelectedDate] = useState(null);
                const [draggedLesson, setDraggedLesson] = useState(null);
                const [isGenerating, setIsGenerating] = useState(false);
                const [statusMsg, setStatusMsg] = useState("");
                const [manualSearchTerm, setManualSearchTerm] = useState("");
                const [showCalendarModal, setShowCalendarModal] = useState(false);

                const [bulkRecurrenceDays, setBulkRecurrenceDays] = useState([4]);
                const [singleAddDate, setSingleAddDate] = useState("");

                // FIX: Helper to ensure consistent JSON object order for saving
                const formatScheduleForSave = (s) => ({
                    date: s.date,
                    lessons: s.lessons || [],
                    isHoliday: !!s.isHoliday,
                    note: s.note || ''
                });

                const scheduledDanceIds = useMemo(() => {
                    const ids = new Set();
                    schedules.forEach(day => {
                        if (day.lessons) {
                            day.lessons.forEach(l => ids.add(l.danceId));
                        }
                    });
                    return ids;
                }, [schedules]);

                const refreshData = async () => {
                    const m = month.getMonth(); const y = month.getFullYear();
                    try {
                        const data = await StorageService.getMonthData(m, y);
                        const schedData = data?.schedules || [];
                        const availData = data?.availability || [];
                        const danceData = data?.dances || [];
                        const cleanSchedules = (schedData || []).map(s => ({ ...s, date: normalizeDate(s.date) }));
                        setSchedules(cleanSchedules);
                        setAvailabilities(availData || []);
                        setAllDances(danceData || []);
                        const loadedDates = cleanSchedules.map(s => s.date).filter(d => true);
                        if (loadedDates.length > 0) {
                            const uniqueDates = Array.from(new Set(loadedDates)).sort();
                            setActiveDates(uniqueDates);
                        } else {
                            setActiveDates([]);
                        }
                    } catch (err) { setStatusMsg("Error loading data."); }
                };

                useEffect(() => { refreshData(); setSelectedDate(null); setStatusMsg(""); }, [month]);

                const generateMonthDates = (dayIndices) => {
                    const daysInMonth = getDaysInMonth(month);
                    const year = month.getFullYear();
                    const m = month.getMonth();
                    const results = [];

                    for (let i = 1; i <= daysInMonth; i++) {
                        const d = new Date(year, m, i);
                        if (dayIndices.includes(d.getDay())) {
                            const yyyy = d.getFullYear();
                            const mm = String(d.getMonth() + 1).padStart(2, '0');
                            const dd = String(d.getDate()).padStart(2, '0');
                            results.push(`${yyyy}-${mm}-${dd}`);
                        }
                    }
                    return results;
                };

                const handleBulkAddDates = async () => {
                    setIsGenerating(true);
                    try {
                        const newDates = generateMonthDates(bulkRecurrenceDays);
                        let addedCount = 0;
                        const toSave = [];
                        for (const dateStr of newDates) {
                            const exists = schedules.find(s => s.date === dateStr);
                            if (!exists) {
                                // Use formatScheduleForSave
                                const newSchedule = formatScheduleForSave({ date: dateStr, lessons: [], isHoliday: false });
                                toSave.push(newSchedule);
                                addedCount++;
                            }
                        }
                        if (toSave.length) {
                            await StorageService.batchSaveDaySchedules(toSave);
                        }
                        await refreshData();
                        setStatusMsg(addedCount > 0 ? `Added ${addedCount} new days.` : "Days already exist.");
                        setShowCalendarModal(false);
                    } catch (err) { console.error(err); setStatusMsg("Error adding dates."); } finally { setIsGenerating(false); }
                };

                const handleAddSingleDate = async () => {
                    if (!singleAddDate) return;
                    setIsGenerating(true);
                    try {
                        const d = parseYMD(singleAddDate);
                        if (d.getMonth() !== month.getMonth() || d.getFullYear() !== month.getFullYear()) {
                            if (!confirm("This date is outside the currently selected month. Add anyway?")) { setIsGenerating(false); return; }
                        }
                        const exists = schedules.find(s => s.date === singleAddDate);
                        if (!exists) {
                            // Use formatScheduleForSave
                            const newSchedule = formatScheduleForSave({ date: singleAddDate, lessons: [], isHoliday: false });
                            await StorageService.batchSaveDaySchedules([newSchedule]);
                            await refreshData(); setStatusMsg("Date added."); setSingleAddDate("");
                        } else { setStatusMsg("Date already exists."); }
                    } catch (err) { setStatusMsg("Failed to add date."); } finally { setIsGenerating(false); }
                };

                const handleRemoveDate = async (dateStr) => {
                    if (!confirm(`Are you sure you want to remove ${dateStr} from the schedule? This deletes all lessons for that day.`)) return;
                    setIsGenerating(true);
                    try {
                        await StorageService.deleteDaySchedule(dateStr);
                        await refreshData();
                        if (selectedDate === dateStr) setSelectedDate(null);
                        setStatusMsg("Date removed.");
                    } catch (err) { console.error(err); setStatusMsg("Failed to delete date."); } finally { setIsGenerating(false); }
                };

                const handleClearSchedule = async () => {
                    if (!confirm("Are you sure you want to reset the schedule for this month? This will remove all lessons and calendar dates for this month, but instructor availability and profile data will remain.")) {
                        return;
                    }
                    try {
                        setIsGenerating(true);
                        await StorageService.clearScheduleForMonth(month.getMonth(), month.getFullYear());
                        await refreshData();
                        setStatusMsg("Schedule reset successfully.");
                    } catch (err) { console.error(err); setStatusMsg("Failed to reset."); } finally { setIsGenerating(false); }
                };

                const toggleHoliday = async (dateStr) => {
                    const schedule = schedules.find(s => s.date === dateStr) || { date: dateStr, lessons: [] };
                    const updated = formatScheduleForSave({ ...schedule, isHoliday: !schedule.isHoliday });

                    await StorageService.saveDaySchedule(updated);
                    setSchedules(prev => { const idx = prev.findIndex(s => s.date === dateStr); if (idx >= 0) { const c = [...prev]; c[idx] = updated; return c; } return [...prev, updated]; });
                };

                const handleAutoGenerate = async () => {
                    setIsGenerating(true); setStatusMsg("Initializing...");
                    try {
                        const instructorLessonCounts = {}; instructors.forEach(i => instructorLessonCounts[i.id] = 0);
                        const currentRunDanceIds = new Set();
                        let lessonsGenerated = 0;
                        const sortedDates = [...activeDates].sort();

                        for (const dateStr of sortedDates) {
                            const currentSched = schedules.find(s => s.date === dateStr);
                            if (currentSched?.isHoliday) continue;

                            const availableInstIds = availabilities.filter(a => (a.availableDates || []).includes(dateStr)).map(a => a.instructorId);
                            if (availableInstIds.length === 0) continue;

                            const shuffled = [...availableInstIds].sort(() => 0.5 - Math.random());
                            const sortedCandidates = shuffled.sort((a, b) => (instructorLessonCounts[a] || 0) - (instructorLessonCounts[b] || 0));
                            const selectedInstructors = sortedCandidates.slice(0, 2);
                            const lessonsForDay = [];

                            const getCandidateDances = (instId) => {
                                const availability = availabilities.find(a => a.instructorId === instId);
                                const prefs = availability?.selectedDances || [];
                                return prefs.filter(d => !currentRunDanceIds.has(d.id));
                            };

                            const candidatesA = getCandidateDances(selectedInstructors[0]);
                            const candidatesB = selectedInstructors.length > 1 ? getCandidateDances(selectedInstructors[1]) : [];
                            let bestPair = null;

                            if (selectedInstructors.length === 1 && candidatesA.length > 0) bestPair = { danceA: candidatesA[0] };
                            else if (selectedInstructors.length === 2) {
                                if (candidatesA.length > 0 && candidatesB.length > 0) {
                                    let maxDiff = -1;
                                    for (const dA of candidatesA) {
                                        for (const dB of candidatesB) {
                                            if (dA.id === dB.id) continue;
                                            const diff = Math.abs(dA.difficulty - dB.difficulty);
                                            if (diff > maxDiff) { maxDiff = diff; bestPair = { danceA: dA, danceB: dB }; }
                                        }
                                    }
                                }
                                if (!bestPair && candidatesA.length > 0) bestPair = { danceA: candidatesA[0] };
                            }

                            if (bestPair) {
                                const assignments = [];
                                if (bestPair.danceA) assignments.push({ instId: selectedInstructors[0], dance: bestPair.danceA });
                                if (bestPair.danceB && selectedInstructors[1]) assignments.push({ instId: selectedInstructors[1], dance: bestPair.danceB });
                                for (const assign of assignments) {
                                    instructorLessonCounts[assign.instId] = (instructorLessonCounts[assign.instId] || 0) + 1;
                                    currentRunDanceIds.add(assign.dance.id);
                                    lessonsForDay.push({ id: `${dateStr}-${assign.instId}-${Date.now()}`, danceId: assign.dance.id, danceName: assign.dance.name, instructorId: assign.instId, timeSlot: '', difficulty: assign.dance.difficulty });
                                }
                            }

                            lessonsForDay.sort((a, b) => a.difficulty - b.difficulty);
                            lessonsForDay.forEach((l, idx) => { l.timeSlot = idx < TIME_SLOTS.length ? TIME_SLOTS[idx] : "Overflow"; });

                            // Use formatScheduleForSave
                            const newSchedule = formatScheduleForSave({ date: dateStr, lessons: lessonsForDay, isHoliday: false });
                            toSave.push(newSchedule);
                            lessonsGenerated += lessonsForDay.length;
                        }
                        if (toSave.length) await StorageService.batchSaveDaySchedules(toSave);
                        await refreshData(); setStatusMsg(`Assigned ${lessonsGenerated} lessons.`); setTimeout(() => setStatusMsg(""), 4000);
                    } catch (e) { console.error(e); setStatusMsg("Generation error."); } finally { setIsGenerating(false); }
                };

                const handleAddLesson = async (dateStr, instructorId, dance) => {
                    const schedule = schedules.find(s => s.date === dateStr) || { date: dateStr, lessons: [], isHoliday: false };
                    if (schedule.lessons.find(l => l.danceId === dance.id)) return;
                    const newLesson = { id: `${dateStr}-${instructorId}-${Date.now()}`, danceId: dance.id, danceName: dance.name, instructorId, difficulty: dance.difficulty, timeSlot: '' };
                    const updatedLessons = [...(schedule.lessons || []), newLesson].sort((a, b) => a.difficulty - b.difficulty);
                    updatedLessons.forEach((l, idx) => { l.timeSlot = idx < TIME_SLOTS.length ? TIME_SLOTS[idx] : "Overflow"; });

                    // Use formatScheduleForSave
                    const updatedSchedule = formatScheduleForSave({ ...schedule, lessons: updatedLessons });
                    setSchedules(prev => { const copy = [...prev]; const idx = copy.findIndex(s => s.date === dateStr); if (idx >= 0) copy[idx] = updatedSchedule; else copy.push(updatedSchedule); return copy; });
                    await StorageService.saveDaySchedule(updatedSchedule);
                };

                const handleDeleteLesson = async (dateStr, lessonId) => {
                    const schedule = schedules.find(s => s.date === dateStr); if (!schedule) return;
                    const updatedLessons = schedule.lessons.filter(l => l.id !== lessonId);
                    updatedLessons.forEach((l, idx) => { if (idx < TIME_SLOTS.length) l.timeSlot = TIME_SLOTS[idx]; });

                    // Use formatScheduleForSave
                    const updatedSchedule = formatScheduleForSave({ ...schedule, lessons: updatedLessons });
                    setSchedules(prev => prev.map(s => s.date === dateStr ? updatedSchedule : s));
                    await StorageService.saveDaySchedule(updatedSchedule);
                };

                const handleDragStart = (e, date, index) => { setDraggedLesson({ date, index }); e.dataTransfer.effectAllowed = "move"; };
                const handleDrop = async (e, targetDate, targetIndex) => {
                    e.preventDefault(); if (!draggedLesson || draggedLesson.date !== targetDate || draggedLesson.index === targetIndex) return;
                    const schedule = schedules.find(s => s.date === targetDate);
                    const newLessons = [...schedule.lessons];
                    [newLessons[draggedLesson.index], newLessons[targetIndex]] = [newLessons[targetIndex], newLessons[draggedLesson.index]];
                    newLessons.forEach((l, idx) => { if (idx < TIME_SLOTS.length) l.timeSlot = TIME_SLOTS[idx]; });

                    // Use formatScheduleForSave
                    const updatedSchedule = formatScheduleForSave({ ...schedule, lessons: newLessons });
                    setSchedules(prev => prev.map(s => s.date === targetDate ? updatedSchedule : s));
                    setDraggedLesson(null);
                    await StorageService.saveDaySchedule(updatedSchedule);
                };

                const handleExport = () => {
                    const rows = schedules.filter(s => !s.isHoliday).flatMap(day => (day.lessons || []).map(l => [format(parseYMD(day.date), 'MM/dd/yyyy'), l.timeSlot, l.danceName, (allDances.find(d => d.id === l.danceId)?.song || ''), getDifficultyLabel(l.difficulty), instructors.find(i => i.id === l.instructorId)?.name || 'Unknown']));
                    const csv = ['Date,Time,Dance,Song,Level,Instructor', ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');
                    const url = window.URL.createObjectURL(new Blob([csv], { type: 'text/csv' }));
                    const a = document.createElement('a'); a.href = url; a.download = `schedule-${format(month, 'yyyy-MM')}.csv`; a.click();
                };

                return (
                    <div className="grid grid-cols-1 lg:grid-cols-3 gap-8 animate-fade-in relative">
                        {showCalendarModal && (
                            <div className="fixed inset-0 z-[60] flex items-center justify-center bg-slate-900/50 backdrop-blur-sm">
                                <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full p-6 m-4">
                                    <div className="flex justify-between items-center mb-6">
                                        <h3 className="text-xl font-bold text-slate-800">Manage Schedule Dates</h3>
                                        <button onClick={() => setShowCalendarModal(false)}><X size={24} className="text-slate-400 hover:text-slate-600" /></button>
                                    </div>
                                    <div className="space-y-6">
                                        <div className="bg-indigo-50 rounded-lg p-4 border border-indigo-100">
                                            <label className="block text-xs font-bold text-indigo-700 uppercase mb-3">1. Bulk Add by Day of Week</label>
                                            <p className="text-xs text-slate-500 mb-3">Select days to add to the schedule for {format(month, 'MMMM')}. Existing lessons will remain untouched.</p>
                                            <div className="flex flex-wrap gap-2 mb-4">
                                                {['S', 'M', 'T', 'W', 'T', 'F', 'S'].map((d, idx) => (
                                                    <button key={idx} onClick={() => setBulkRecurrenceDays(prev => prev.includes(idx) ? prev.filter(x => x !== idx) : [...prev, idx])} className={`w-10 h-10 rounded-full font-bold text-sm transition-all ${bulkRecurrenceDays.includes(idx) ? 'bg-indigo-600 text-white shadow-md scale-110' : 'bg-white text-slate-500 border border-slate-200 hover:border-indigo-300'}`}>{d}</button>
                                                ))}
                                            </div>
                                            <button onClick={handleBulkAddDates} disabled={isGenerating} className="w-full bg-indigo-600 hover:bg-indigo-700 text-white py-2 rounded-lg text-sm font-semibold shadow-sm">Add Selected Days to Schedule</button>
                                        </div>
                                        <div className="relative flex justify-center text-xs uppercase text-slate-400 font-bold my-2"><span className="bg-white px-2">OR</span></div>
                                        <div className="bg-slate-50 rounded-lg p-4 border border-slate-200">
                                            <label className="block text-xs font-bold text-slate-600 uppercase mb-3">2. Add Specific Date</label>
                                            <div className="flex space-x-2">
                                                <input type="date" className="flex-grow border border-slate-300 rounded-lg px-3 py-2 text-sm outline-none focus:border-indigo-500" value={singleAddDate} onChange={(e) => setSingleAddDate(e.target.value)} />
                                                <button onClick={handleAddSingleDate} disabled={!singleAddDate || isGenerating} className="bg-slate-800 hover:bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-semibold"><Plus size={16} /></button>
                                            </div>
                                        </div>
                                    </div>
                                    <div className="mt-6 pt-4 border-t border-slate-100 flex justify-end"><button onClick={() => setShowCalendarModal(false)} className="text-slate-500 hover:text-slate-700 text-sm font-medium px-4">Close</button></div>
                                </div>
                            </div>
                        )}
                        <div className="lg:col-span-2 space-y-6">
                            <div className="flex flex-wrap gap-3 justify-between items-center bg-white p-4 rounded-xl border border-slate-200 shadow-sm">
                                <h2 className="text-xl font-bold text-slate-800 flex items-center"><CalIcon className="mr-2 text-indigo-600" /> Schedule: {format(month, 'MMMM yyyy')}</h2>
                                <div className="flex items-center gap-2">
                                    {statusMsg && <span className="text-sm text-indigo-600 font-medium mr-2">{statusMsg}</span>}
                                    <button onClick={handleClearSchedule} className="p-2 text-slate-400 hover:text-red-600 hover:bg-red-50 rounded-lg" title="Reset Month Schedule (Keeps Instructor Data)"><Trash2 size={18} /></button>
                                    <div className="h-4 w-px bg-slate-200 mx-1"></div>
                                    <button onClick={() => setShowCalendarModal(true)} className="flex items-center text-sm bg-slate-100 hover:bg-slate-200 text-slate-700 px-3 py-2 rounded-lg transition-colors font-medium" title="Manage Days"><Settings size={16} className="mr-2" /> Manage Dates</button>
                                    <button onClick={handleAutoGenerate} disabled={isGenerating} className="text-sm flex items-center bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg transition-colors shadow-sm disabled:opacity-50">{isGenerating ? <RefreshCcw className="animate-spin mr-2" size={16} /> : <Wand2 size={16} className="mr-2" />} Generate</button>
                                    <button onClick={handleExport} className="text-sm flex items-center bg-slate-100 hover:bg-slate-200 text-slate-700 px-4 py-2 rounded-lg transition-colors"><Download size={16} className="mr-2" /> Export</button>
                                </div>
                            </div>
                            <div className="space-y-4">
                                {activeDates.length === 0 ? (
                                    <div className="p-12 text-center border-2 border-dashed border-slate-200 rounded-xl bg-slate-50/50"><CalIcon className="mx-auto h-12 w-12 text-slate-300 mb-3" /><h3 className="text-lg font-medium text-slate-900">No days scheduled</h3><p className="text-slate-500 mb-4">Start by adding dates to the schedule.</p><button onClick={() => setShowCalendarModal(true)} className="inline-flex items-center text-indigo-600 font-semibold hover:text-indigo-800">Manage Dates <ArrowRight size={16} className="ml-1" /></button></div>
                                ) : activeDates.map(dateStr => {
                                    const displayDate = parseYMD(dateStr);
                                    const schedule = schedules.find(s => s.date === dateStr);
                                    const isSelected = selectedDate === dateStr;
                                    const isHoliday = schedule?.isHoliday;
                                    return (
                                        <div key={dateStr} className={`rounded-xl border transition-all overflow-hidden ${isSelected ? 'ring-2 ring-indigo-500 border-indigo-500 shadow-md' : 'border-slate-200 shadow-sm bg-white'}`}>
                                            <div onClick={() => setSelectedDate(dateStr)} className={`px-6 py-3 border-b cursor-pointer flex justify-between items-center transition-colors ${isHoliday ? 'bg-slate-100 border-slate-200' : isSelected ? 'bg-indigo-50 border-indigo-100' : 'bg-slate-50 border-slate-100 hover:bg-slate-100'}`}>
                                                <div className="flex items-center space-x-3"><div className={`text-2xl font-bold ${isHoliday ? 'text-slate-400' : isSelected ? 'text-indigo-800' : 'text-slate-800'}`}>{format(displayDate, 'd')}</div><div className="text-sm font-medium text-slate-500 uppercase tracking-wider">{format(displayDate, 'EEEE')}</div></div>
                                                <div className="flex items-center space-x-3">{!isHoliday && schedule && schedule.lessons && schedule.lessons.length > 0 && !isSelected && (<div className="flex -space-x-2">{schedule.lessons.map(l => <div key={l.id} className="w-6 h-6 rounded-full bg-indigo-100 border border-white flex items-center justify-center text-xs font-bold text-indigo-700" title={instructors.find(i => i.id === l.instructorId)?.name}>{instructors.find(i => i.id === l.instructorId)?.name.charAt(0) || '?'}</div>)}</div>)}{isHoliday && <span className="text-xs font-bold text-slate-400 bg-slate-200 px-2 py-1 rounded-full">NO LESSONS</span>}{isSelected && <span className="text-xs font-bold text-indigo-600 bg-white px-2 py-1 rounded-full">Editing</span>}<button onClick={(e) => { e.stopPropagation(); handleRemoveDate(dateStr); }} className="ml-2 p-1.5 text-slate-300 hover:text-red-500 hover:bg-red-50 rounded-full transition-colors" title="Remove Date"><Trash2 size={16} /></button></div>
                                            </div>
                                            {!isHoliday ? (
                                                <div className="p-4 space-y-3 bg-white min-h-[100px]">
                                                    {schedule?.lessons && schedule.lessons.length > 0 ? (
                                                        schedule.lessons.map((lesson, idx) => (
                                                            <div key={lesson.id} draggable onDragStart={(e) => handleDragStart(e, dateStr, idx)} onDrop={(e) => handleDrop(e, dateStr, idx)} onDragOver={(e) => e.preventDefault()} className={`relative flex items-center p-3 rounded-lg border-l-4 bg-white shadow-sm transition-all cursor-move group ${draggedLesson?.date === dateStr && draggedLesson?.index === idx ? 'opacity-50 border-indigo-300' : 'border-indigo-500 hover:shadow-md'}`}>
                                                                <div className="text-slate-400 mr-3 cursor-grab active:cursor-grabbing"><GripVertical size={18} /></div>
                                                                <div className="w-20 font-mono text-sm font-bold text-slate-600">{lesson.timeSlot}</div>
                                                                <div className="flex-grow"><div className="flex justify-between items-start"><div className="font-semibold text-slate-800">{lesson.danceName}</div><div className="text-xs font-bold text-indigo-600 bg-indigo-50 px-2 py-1 rounded-full flex items-center"><User size={12} className="mr-1" /> {instructors.find(i => i.id === lesson.instructorId)?.name || 'Unknown'}</div></div><div className="text-xs text-slate-500 flex items-center mt-1"><span className={`px-2 py-0.5 rounded-full text-[10px] font-bold mr-2 ${getDifficultyColor(lesson.difficulty)}`}>{getDifficultyLabel(lesson.difficulty)}</span></div></div>
                                                                <button onClick={(e) => { e.stopPropagation(); handleDeleteLesson(dateStr, lesson.id); }} className="opacity-0 group-hover:opacity-100 absolute top-2 right-2 p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 rounded transition-all"><Trash2 size={14} /></button>
                                                            </div>
                                                        ))
                                                    ) : (
                                                        <div onClick={() => setSelectedDate(dateStr)} className="text-center py-8 border-2 border-dashed border-slate-100 rounded-lg hover:bg-slate-50 hover:border-slate-300 transition-all cursor-pointer"><Plus className="mx-auto h-8 w-8 text-slate-300 mb-2" /><p className="text-sm text-slate-400 font-medium">No lessons.</p></div>
                                                    )}
                                                    <div className="text-right mt-2"><button onClick={(e) => { e.stopPropagation(); toggleHoliday(dateStr); }} className="text-[10px] text-red-400 hover:underline">Mark as No Lessons/Holiday</button></div>
                                                </div>
                                            ) : (<div className="p-8 text-center bg-slate-50"><div className="text-slate-400 text-sm mb-2">This day is marked as a holiday or no lessons.</div><button onClick={() => toggleHoliday(dateStr)} className="text-xs bg-white border border-slate-300 px-3 py-1 rounded text-slate-600">Re-open Day</button></div>)}
                                        </div>
                                    );
                                })}
                            </div>
                        </div>
                        <div className="lg:col-span-1">
                            <div className="bg-white rounded-xl shadow-sm border border-slate-200 p-6 sticky top-24 max-h-[calc(100vh-100px)] overflow-y-auto flex flex-col">
                                {selectedDate ? (
                                    <div className="animate-fade-in flex-grow flex flex-col">
                                        <div className="flex justify-between items-start mb-4 border-b pb-2 flex-shrink-0"><div><h3 className="text-lg font-bold text-slate-800">Add Lesson</h3><p className="text-sm text-indigo-600 font-medium">{format(parseYMD(selectedDate), 'MMMM d, yyyy')}</p></div><button onClick={() => setSelectedDate(null)} className="text-slate-400 hover:text-slate-600"><X size={20} /></button></div>
                                        <div className="flex-grow overflow-y-auto pr-1">
                                            <div className="mb-4"><h4 className="text-xs font-bold text-slate-400 uppercase mb-2">Available Instructors</h4><div className="space-y-3">
                                                {instructors.filter(i => availabilities.find(a => a.instructorId === i.id)?.availableDates?.includes(selectedDate)).map(inst => {
                                                    const availability = availabilities.find(a => a.instructorId === inst.id);
                                                    const prefDances = availability?.selectedDances || [];
                                                    const filteredPrefDances = prefDances.filter(d => {
                                                        if (scheduledDanceIds.has(d.id)) return false;
                                                        if (manualSearchTerm && !d.name.toLowerCase().includes(manualSearchTerm.toLowerCase())) return false;
                                                        return true;
                                                    });
                                                    return (
                                                        <div key={inst.id} className="border border-indigo-100 bg-indigo-50/30 rounded-lg p-3 transition-all shadow-sm">
                                                            <div className="flex items-center justify-between mb-2"><div className="flex items-center"><CheckCircle size={14} className="text-green-500 mr-2" /><span className="font-bold text-sm text-slate-800">{inst.name}</span></div></div>
                                                            <div className="grid grid-cols-1 gap-2">{filteredPrefDances.length > 0 ? filteredPrefDances.map(dance => (<button key={dance.id} onClick={() => handleAddLesson(selectedDate, inst.id, dance)} className="text-left text-xs p-2 bg-white border border-slate-200 rounded hover:border-indigo-400 hover:shadow-sm transition-all flex items-center justify-between group"><div className="truncate pr-2"><div className="font-semibold text-slate-700 truncate">{dance.name}</div>{dance.song && <div className="text-[10px] text-slate-400 truncate">{dance.song}</div>}<div className={`inline-block mt-1 px-1.5 py-0.5 rounded text-[10px] ${getDifficultyColor(dance.difficulty)}`}>{getDifficultyLabel(dance.difficulty)}</div></div><Plus size={14} className="text-indigo-400 opacity-0 group-hover:opacity-100 flex-shrink-0" /></button>)) : <div className="text-xs text-slate-400 italic px-1">All preferences scheduled.</div>}</div>
                                                            <div className="mt-2 pt-2 border-t border-slate-100/50">
                                                                <AdminGlobalSearch allDances={allDances} scheduledDanceIds={scheduledDanceIds} onSelect={(dance) => handleAddLesson(selectedDate, inst.id, dance)} onTermChange={(v)=> setManualSearchTerm(v)} />
                                                            </div>
                                                        </div>
                                                    );
                                                })}
                                                {instructors.filter(i => availabilities.find(a => a.instructorId === i.id)?.availableDates?.includes(selectedDate)).length === 0 && <div className="text-xs text-slate-400 italic text-center py-2">No instructors available for this date.</div>}
                                            </div></div>
                                            <div><h4 className="text-xs font-bold text-slate-400 uppercase mb-2 border-t pt-2">Other Instructors</h4><div className="space-y-2">
                                                {instructors.filter(i => !availabilities.find(a => a.instructorId === i.id)?.availableDates?.includes(selectedDate)).map(inst => {
                                                    const avail = availabilities.find(a => a.instructorId === inst.id);
                                                    const isPending = !avail;
                                                    return (
                                                        <div key={inst.id} className="flex items-center justify-between p-2 rounded border border-slate-100 bg-slate-50/50 opacity-75"><div className="flex items-center"><XCircle size={14} className="text-slate-300 mr-2" /><span className="text-xs font-medium text-slate-500">{inst.name}</span></div><span className={`text-[10px] px-1.5 py-0.5 rounded ${isPending ? 'bg-slate-200 text-slate-500' : 'bg-orange-100 text-orange-600'}`}>{isPending ? 'Pending' : 'Busy'}</span></div>
                                                    );
                                                })}
                                            </div></div>
                                        </div>
                                    </div>
                                ) : (
                                    <div className="text-center py-12 flex-grow flex flex-col justify-center"><div className="bg-indigo-50 w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4"><CalIcon className="text-indigo-500" size={32} /></div><h3 className="text-slate-800 font-bold mb-2">Select a Date</h3><p className="text-sm text-slate-500">Click on any date in the schedule to manage lessons.</p></div>
                                )}
                                <div className="mt-6 pt-6 border-t border-slate-100 flex-shrink-0"><h4 className="text-xs font-bold text-slate-400 uppercase mb-3">Month Overview</h4><div className="grid grid-cols-2 gap-2 text-xs"><div className="bg-slate-50 p-2 rounded text-center"><div className="font-bold text-slate-700">{availabilities.length}</div><div className="text-slate-400">Submitted</div></div><div className="bg-slate-50 p-2 rounded text-center"><div className="font-bold text-slate-700">{instructors.length - availabilities.length}</div><div className="text-slate-400">Pending</div></div></div></div>
                            </div>
                        </div>
                    </div>
                );
            };

            /* --- App --- */
            const App = () => {
                const [instructors, setInstructors] = useState([]);
                const [isLoading, setIsLoading] = useState(true);
                const [state, setState] = useState(() => {
                    const now = new Date();
                    // Default to the 1st of the NEXT month
                    const nextMonth = new Date(now.getFullYear(), now.getMonth() + 1, 1);
                    return { currentUser: null, viewMode: 'instructor', selectedMonth: nextMonth };
                });

                // Admin Auth
                const [showAdminAuth, setShowAdminAuth] = useState(false);
                const [adminPwd, setAdminPwd] = useState("");
                const [authError, setAuthError] = useState(false);

                useEffect(() => {
                    const loadInstructors = async () => {
                        try { const data = await StorageService.getInstructors(); setInstructors(data || []); }
                        catch (err) { console.error(err); } finally { setIsLoading(false); }
                    };
                    loadInstructors();
                }, []);

                const handleLogin = (id) => { const i = instructors.find(x => x.id === id); if (i) setState(prev => ({ ...prev, currentUser: i, viewMode: 'instructor' })); };

                const handleAdminLoginClick = () => { setShowAdminAuth(true); setAdminPwd(""); setAuthError(false); };

                const verifyAdminPassword = (e) => {
                    e.preventDefault();
                    if (adminPwd === "annoyedbutfine.") {
                        setState(prev => ({ ...prev, currentUser: { id: 'admin', name: 'Admin' }, viewMode: 'admin' }));
                        setShowAdminAuth(false);
                    } else {
                        setAuthError(true);
                    }
                };

                const changeMonth = (delta) => setState(prev => ({ ...prev, selectedMonth: addMonths(prev.selectedMonth, delta) }));

                if (!state.currentUser) {
                    return (
                        <Layout title="Login">
                            <div className="max-w-md mx-auto bg-white p-8 rounded-2xl shadow-lg border border-indigo-100 mt-10 relative">
                                <h2 className="text-2xl font-bold text-center text-indigo-900 mb-2">Welcome Back</h2>
                                {isLoading ? <div className="flex flex-col items-center justify-center py-8 text-slate-400"><Loader2 className="animate-spin mb-2" size={32} /><span>Loading...</span></div> : (
                                    <div className="space-y-3">
                                        {instructors.length === 0 ? (
                                            <div className="text-center p-4 bg-orange-50 rounded-lg border border-orange-200 text-orange-700 text-sm">
                                                <p><strong>No instructors found.</strong></p>
                                                <p className="mt-1">Please add data to the "Instructors" tab in the Google Sheet.</p>
                                            </div>
                                        ) : (
                                            <>
                                                <label className="block text-xs font-bold text-slate-400 uppercase tracking-wider mb-2">Instructors</label>
                                                <div className="grid grid-cols-2 gap-3">{instructors.map(inst => (<button key={inst.id} onClick={() => handleLogin(inst.id)} className="flex items-center justify-center space-x-2 p-3 border border-slate-200 rounded-lg hover:bg-indigo-50 hover:border-indigo-300 transition-all text-slate-700 text-sm font-medium"><UserCircle size={18} className="text-indigo-400" /><span>{inst.name}</span></button>))}</div>
                                            </>
                                        )}
                                        <div className="relative my-6"><div className="absolute inset-0 flex items-center"><div className="w-full border-t border-slate-200"></div></div><div className="relative flex justify-center text-xs uppercase"><span className="bg-white px-2 text-slate-400">Or</span></div></div>

                                        <button onClick={handleAdminLoginClick} className="w-full flex items-center justify-center space-x-2 bg-slate-900 text-white p-3 rounded-lg hover:bg-slate-800 transition-colors shadow-md"><ShieldCheck size={18} /><span>Access Admin Dashboard</span></button>
                                    </div>
                                )}
                                {showAdminAuth && (
                                    <div id="admin-auth-overlay" className="absolute inset-0 z-10 bg-slate-900/95 backdrop-blur-sm rounded-2xl flex flex-col items-center justify-center p-6 animate-fade-in text-white">
                                            <div className="bg-indigo-800/40 p-3 rounded-full mb-4"><ShieldCheck className="text-indigo-300" size={32} /></div>
                                        <h3 className="text-lg font-bold text-slate-800 mb-1">Admin Access</h3><p className="text-xs text-slate-500 mb-4">Enter password to continue</p>
                                        <form onSubmit={verifyAdminPassword} className="w-full max-w-xs">
                                            <input type="password" autoFocus value={adminPwd} onChange={(e) => { setAdminPwd(e.target.value); setAuthError(false); }} className={`w-full px-4 py-2 rounded-lg border ${authError ? 'border-red-500 bg-red-900/30 text-red-200' : 'border-slate-700 bg-slate-800 focus:border-indigo-500'} outline-none text-sm mb-2`} placeholder="Password" />
                                            {authError && <p className="text-xs text-red-400 mb-3 text-center font-medium">Incorrect password</p>}
                                            <div className="flex gap-2 mt-2"><button type="button" onClick={() => setShowAdminAuth(false)} className="flex-1 py-2 rounded-lg text-sm text-slate-500 hover:bg-slate-100">Cancel</button><button type="submit" className="flex-1 py-2 rounded-lg text-sm bg-indigo-600 text-white hover:bg-indigo-700 font-medium">Unlock</button></div>
                                        </form>
                                    </div>
                                )}
                            </div>
                        </Layout>
                    );
                }

                return (
                    <Layout title={state.viewMode === 'admin' ? 'Admin Dashboard' : 'Instructor Portal'} user={state.currentUser.name} onLogout={() => setState(prev => ({ ...prev, currentUser: null }))}>
                        <div className="flex justify-center items-center mb-8 bg-white inline-flex mx-auto rounded-full shadow-sm border border-slate-200 p-1">
                            <button onClick={() => changeMonth(-1)} className="p-2 hover:bg-slate-100 rounded-full text-slate-500"><ArrowLeft size={20} /></button>
                            <div className="px-6 font-bold text-slate-800 min-w-[160px] text-center">{format(state.selectedMonth, 'MMMM yyyy')}</div>
                            <button onClick={() => changeMonth(1)} className="p-2 hover:bg-slate-100 rounded-full text-slate-500"><ArrowRight size={20} /></button>
                        </div>
                        {state.viewMode === 'admin' ? <AdminDashboard month={state.selectedMonth} instructors={instructors} /> : <InstructorPortal instructor={state.currentUser} month={state.selectedMonth} />}
                    </Layout>
                );
            };

            // Contrast checking helpers (audit foreground/background combos)
            const sRGBtoLinear = (c) => {
                c = c/255;
                return c <= 0.03928 ? c/12.92 : Math.pow((c+0.055)/1.055, 2.4);
            };
            const luminance = ({ r, g, b }) => {
                return 0.2126 * sRGBtoLinear(r) + 0.7152 * sRGBtoLinear(g) + 0.0722 * sRGBtoLinear(b);
            };
            const parseColor = (val) => {
                if (!val) return { r:0, g:0, b:0 };
                val = val.trim();
                if (val.startsWith('rgb')) {
                    const m = val.match(/rgba?\(([^)]+)\)/);
                    if (!m) return { r:0, g:0, b:0 };
                    const parts = m[1].split(',').map(p => parseFloat(p));
                    return { r: parts[0], g: parts[1], b: parts[2] };
                }
                if (val.startsWith('#')) {
                    let h = val.replace('#', '');
                    if (h.length === 3) h = h.split('').map(c => c + c).join('');
                    const bigint = parseInt(h, 16);
                    return { r: (bigint >> 16) & 255, g: (bigint >> 8) & 255, b: bigint & 255 };
                }
                // fallback for rgb hex-like string
                return { r:0, g:0, b:0 };
            };
            const contrastRatio = (fg, bg) => {
                const rgb1 = parseColor(fg);
                const rgb2 = parseColor(bg);
                const L1 = luminance(rgb1);
                const L2 = luminance(rgb2);
                const lighter = Math.max(L1, L2);
                const darker = Math.min(L1, L2);
                return (lighter + 0.05) / (darker + 0.05);
            };
            const runContrastChecks = () => {
                try {
                    const checks = [];
                    const pushCheck = (name, el) => {
                        if (!el) return;
                        const cs = window.getComputedStyle(el);
                        checks.push({ name, fg: cs.color, bg: cs.backgroundColor });
                    };
                    pushCheck('body', document.body);
                    pushCheck('header', document.querySelector('header'));
                    document.querySelectorAll('button, .bg-indigo-600, .bg-slate-50, .bg-white, .bg-slate-900, input, textarea').forEach((el, idx) => {
                        const name = el.tagName.toLowerCase() + '-' + idx;
                        const cs = window.getComputedStyle(el);
                        checks.push({ name, fg: cs.color, bg: cs.backgroundColor });
                    });
                    // Panels: card-like elements
                    document.querySelectorAll('.rounded-xl, .rounded-lg, .bg-white').forEach((el, idx) => { const cs = window.getComputedStyle(el); checks.push({ name: 'panel-'+idx, fg: cs.color, bg: cs.backgroundColor }); });

                    const low = checks.map(c => ({ ...c, ratio: contrastRatio(c.fg, c.bg) })).filter(c => c.ratio < 4.5);
                    console.group('Contrast check: ' + checks.length + ' items');
                    if (low.length) console.table(low.map(x => ({ name: x.name, fg: x.fg, bg: x.bg, ratio: x.ratio.toFixed(2) })));
                    else console.log('All checked combos meet 4.5:1');
                    console.groupEnd();
                    return low;
                } catch (e) {
                    console.error('Contrast check failed', e);
                    return [];
                }
            };

            // Run contrast checks after render so CSS variables apply
            setTimeout(() => { const issues = runContrastChecks(); if (issues.length) console.warn('Contrast warnings: examine console for details'); }, 1200);

            // Mount
            const rootElement = document.getElementById('root');
            if (!rootElement) throw new Error("Root element not found");
            const root = ReactDOM.createRoot(rootElement);
            root.render(<App />);

        } catch (err) {
            console.error(err);
            document.getElementById('root').style.display = 'none';
            document.getElementById('startup-error').style.display = 'block';
            document.getElementById('error-message').textContent = err.toString();
        }
    </script>
</body>

</html>