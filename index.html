<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neon Boots DJ Request App</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for the 'Brush Script MT' style -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Teko:wght@700&display=swap" rel="stylesheet">
    <style>
        /* Custom font for the header to approximate the neon sign look */
        .font-neon {
            font-family: 'Teko', sans-serif;
            text-shadow: 0 0 5px #ff00ff, 0 0 10px #ff00ff, 0 0 20px #ff00ff, 0 0 40px #00ffff, 0 0 80px #00ffff;
        }
        .neon-checkmark {
            filter: drop-shadow(0 0 3px #39ff14) drop-shadow(0 0 5px #39ff14);
        }
        .now-playing-glow {
            box-shadow: 0 0 8px #00ffff, 0 0 12px #00ffff;
        }
        .rating-button {
            transition: transform 0.1s ease-in-out;
        }
        .rating-button.selected {
            transform: scale(1.25);
        }
    </style>
</head>
<body class="bg-gray-900">
    <!-- Root element for the React app -->
    <div id="root"></div>

    <!-- React and Babel CDNs for in-browser JSX transformation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Firebase SDKs (Compat version for broader compatibility) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <!-- React Application Code -->
    <script type="text/babel">
        // Since we're not using a bundler, we get React functions from the global 'React' object
        const { useState, useEffect, useRef, useCallback } = React;
        
        // --- Firebase Configuration ---
        const firebaseConfig = {
            apiKey: "AIzaSyBKmzMtCnEWIFEiq6WK6f1E4JTCkC2tnt0",
            authDomain: "neonbootsdjapp.firebaseapp.com",
            projectId: "neonbootsdjapp",
            storageBucket: "neonbootsdjapp.appspot.com",
            messagingSenderId: "916767461225",
            appId: "1:916767461225:web:aa07f19c1719cba8d837f8",
            measurementId: "G-P1KDRD91W3"
        };

        // --- Initialize Firebase (Compat Syntax) ---
        let app;
        let db;
        try {
            app = firebase.initializeApp(firebaseConfig);
            db = firebase.firestore();
        } catch (error) {
            console.error("Firebase initialization error. Please provide your Firebase config.", error);
        }

        const lineDancesList = [
            { name: 'Tush Push', song: 'Tush Push', artist: 'Trisha Yearwood' },
            { name: 'Copperhead Road', song: 'Copperhead Road', artist: 'Steve Earle' },
            { name: 'Watermelon Crawl', song: 'Watermelon Crawl', artist: 'Tracy Byrd' },
            { name: 'Boot Scootin\' Boogie', song: 'Boot Scootin\' Boogie', artist: 'Brooks & Dunn' },
        ];

        const partnerDancesList = [
            { name: 'Two Step' },
            { name: 'Triple Two' },
            { name: 'Cha Cha' },
            { name: 'Polka' },
            { name: 'Waltz' },
            { name: 'West Coast Swing' },
            { name: 'East Coast Swing' },
            { name: 'Night Club Two Step' },
        ];

        // --- Helper Functions for Firestore ---
        const seedInitialData = async () => {
            if (!db) return;
            const configDocSnap = await db.collection('config').doc('seeded').get();
            if (configDocSnap.exists) {
                return; // Already seeded
            }

            console.log("Empty database detected. Seeding initial data...");
            const batch = db.batch();

            const sampleRequests = [
                { danceName: 'Electric Slide', songName: 'Electric Boogie', artist: 'Marcia Griffiths', customerName: 'Brenda', spotifyLink: '', createdAt: new Date() },
                { danceName: 'Two Step', songName: 'Any Man of Mine', artist: 'Shania Twain', customerName: 'Dave', spotifyLink: '', createdAt: new Date() },
            ];
            sampleRequests.forEach(req => {
                const docRef = db.collection('requests').doc();
                batch.set(docRef, req);
            });

            const sampleQueue = [
                { type: 'song', danceName: 'Tush Push', songName: 'Tush Push', artist: 'Trisha Yearwood', order: 1, played: true, likes: [], dislikes: [] },
                { type: 'event', danceName: 'Line Dance Lesson', songName: 'Teaching: Copperhead Road', artist: '', order: 2, played: false, likes: [], dislikes: [] },
                { type: 'song', danceName: 'Good Time', songName: 'Good Time', artist: 'Alan Jackson', order: 3, played: false, likes: [], dislikes: [] },
            ];
            sampleQueue.forEach(item => {
                const docRef = db.collection('queue').doc();
                batch.set(docRef, item);
            });

            batch.set(db.collection('config').doc('seeded'), { done: true });

            await batch.commit();
            console.log("Initial data seeded.");
        };

        // --- React Components ---

        const Modal = ({ show, onClose, title, children }) => {
            if (!show) return null;
            return (
                <div className="fixed inset-0 bg-black bg-opacity-70 z-50 flex justify-center items-center p-4">
                    <div className="bg-gray-800 rounded-lg shadow-xl w-full max-w-md p-6 relative">
                        <h2 className="text-2xl font-bold text-pink-400 mb-4">{title}</h2>
                        <button onClick={onClose} className="absolute top-4 right-4 text-gray-400 hover:text-white text-2xl">&times;</button>
                        {children}
                    </div>
                </div>
            );
        };

        const ConfirmModal = ({ show, onClose, onConfirm, title, message }) => {
            if (!show) return null;
            return (
                <Modal show={show} onClose={onClose} title={title}>
                    <p className="text-gray-300 mb-6">{message}</p>
                    <div className="flex justify-end gap-4">
                        <button onClick={onClose} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button onClick={onConfirm} className="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg">Confirm</button>
                    </div>
                </Modal>
            );
        };

        const PromptModal = ({ show, onClose, onConfirm, title, message }) => {
            const [inputValue, setInputValue] = useState('');
            if (!show) return null;

            const handleConfirm = () => {
                onConfirm(inputValue);
                setInputValue('');
            };

            return (
                <Modal show={show} onClose={onClose} title={title}>
                    <p className="text-gray-300 mb-4">{message}</p>
                    <input 
                        type="text" 
                        value={inputValue} 
                        onChange={(e) => setInputValue(e.target.value)} 
                        className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600 mb-6"
                        placeholder="Optional notes..."
                    />
                    <div className="flex justify-end gap-4">
                        <button onClick={onClose} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button onClick={handleConfirm} className="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg">Add Event</button>
                    </div>
                </Modal>
            );
        };
        
        const LineDanceLessonModal = ({ show, onClose, onConfirm }) => {
            const [selectedDance, setSelectedDance] = useState('');
            if (!show) return null;

            const handleConfirm = () => {
                if (selectedDance) {
                    onConfirm(selectedDance);
                }
            };

            return (
                <Modal show={show} onClose={onClose} title="Select Dance for Lesson">
                    <p className="text-gray-300 mb-4">Which dance will be taught?</p>
                    <select value={selectedDance} onChange={e => setSelectedDance(e.target.value)} className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600 mb-6">
                        <option value="">-- Select a Dance --</option>
                        {lineDancesList.map(dance => <option key={dance.name} value={dance.name}>{dance.name}</option>)}
                    </select>
                    <div className="flex justify-end gap-4">
                        <button onClick={onClose} className="bg-gray-600 hover:bg-gray-500 text-white font-bold py-2 px-4 rounded-lg">Cancel</button>
                        <button onClick={handleConfirm} disabled={!selectedDance} className="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg disabled:opacity-50">Add Lesson</button>
                    </div>
                </Modal>
            );
        };

        const TippingSection = ({ tippingInfo }) => {
            if (!tippingInfo?.venmo && !tippingInfo?.cashapp) {
                return null;
            }
            return (
                <div className="border-t border-gray-700 pt-4 mt-8 text-center">
                    <p className="text-lg text-cyan-300 font-semibold mb-2">Enjoying the music? Tip the DJ!</p>
                    {tippingInfo.venmo && <a href={`https://venmo.com/${tippingInfo.venmo}`} target="_blank" rel="noopener noreferrer" className="inline-block text-white bg-blue-600 hover:bg-blue-700 rounded-lg px-4 py-2 my-2 mx-2">Venmo: @{tippingInfo.venmo}</a>}
                    {tippingInfo.cashapp && <a href={`https://cash.app/$${tippingInfo.cashapp}`} target="_blank" rel="noopener noreferrer" className="inline-block text-white bg-green-500 hover:bg-green-600 rounded-lg px-4 py-2 my-2 mx-2">Cash App: ${tippingInfo.cashapp}</a>}
                </div>
            );
        };

        const RequestForm = ({ onClose, tippingInfo, formType }) => {
            const [danceName, setDanceName] = useState('');
            const [songName, setSongName] = useState('');
            const [artist, setArtist] = useState('');
            const [spotifyLink, setSpotifyLink] = useState('');
            const [customerName, setCustomerName] = useState('');
            const [showThanksModal, setShowThanksModal] = useState(false);

            const isLineDance = formType === 'line';
            const danceList = isLineDance ? lineDancesList : partnerDancesList;
            const quickSelectLabel = isLineDance ? "Quick Select a Line Dance" : "Quick Select a Dance Style";

            const handleDanceSelect = (e) => {
                const selectedDanceName = e.target.value;
                const dance = danceList.find(d => d.name === selectedDanceName);
                if (dance) {
                    setDanceName(dance.name);
                    if (isLineDance) {
                        setSongName(dance.song || '');
                        setArtist(dance.artist || '');
                    } else {
                        setSongName('');
                        setArtist('');
                    }
                } else {
                    setDanceName('');
                    setSongName('');
                    setArtist('');
                }
            };

            const handleSubmit = async (e) => {
                e.preventDefault();
                if (!danceName || !songName || !artist || !customerName || !db) return;
                try {
                    await db.collection('requests').add({ danceName, songName, artist, spotifyLink, customerName, createdAt: new Date() });
                    setShowThanksModal(true);
                } catch (error) {
                    console.error("Error adding request: ", error);
                }
            };

            if (showThanksModal) {
                return (
                    <div className="text-center">
                        <h2 className="text-2xl font-bold text-pink-400 mb-4">Thank You!</h2>
                        <p className="text-gray-200 mb-4">Your request has been sent to the DJ.</p>
                        <TippingSection tippingInfo={tippingInfo} />
                        <button onClick={() => { setShowThanksModal(false); onClose(); }} className="mt-4 bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg w-full">Close</button>
                    </div>
                );
            }

            return (
                <form onSubmit={handleSubmit}>
                    <div className="mb-4">
                        <label htmlFor="dance-select" className="block text-cyan-300 text-sm font-bold mb-2">{quickSelectLabel}</label>
                        <select id="dance-select" onChange={handleDanceSelect} className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600">
                            <option value="">-- Select a Dance --</option>
                            {danceList.map(dance => <option key={dance.name} value={dance.name}>{dance.name}</option>)}
                        </select>
                    </div>
                    <p className="text-center text-gray-400 my-2">OR</p>
                    <div className="mb-4">
                        <label htmlFor="dance-name" className="block text-cyan-300 text-sm font-bold mb-2">Dance Name/Style*</label>
                        <input type="text" id="dance-name" value={danceName} onChange={e => setDanceName(e.target.value)} required className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600" />
                    </div>
                    <div className="mb-4">
                        <label htmlFor="song-name" className="block text-cyan-300 text-sm font-bold mb-2">Song Name*</label>
                        <input type="text" id="song-name" value={songName} onChange={e => setSongName(e.target.value)} required className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600" />
                    </div>
                    <div className="mb-4">
                        <label htmlFor="artist-name" className="block text-cyan-300 text-sm font-bold mb-2">Artist*</label>
                        <input type="text" id="artist-name" value={artist} onChange={e => setArtist(e.target.value)} required className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600" />
                    </div>
                    <div className="mb-4">
                        <label htmlFor="spotify-link" className="block text-cyan-300 text-sm font-bold mb-2">Spotify Link (Optional)</label>
                        <input type="url" id="spotify-link" value={spotifyLink} onChange={e => setSpotifyLink(e.target.value)} className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600" />
                    </div>
                    <div className="mb-4">
                        <label htmlFor="customer-name" className="block text-cyan-300 text-sm font-bold mb-2">Your Name*</label>
                        <input type="text" id="customer-name" value={customerName} onChange={e => setCustomerName(e.target.value)} required className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600" />
                    </div>
                    <button type="submit" className="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg w-full">Submit Request</button>
                </form>
            );
        };

        const DJLogin = ({ onLogin }) => {
            const [djName, setDjName] = useState('');
            const [password, setPassword] = useState('');
            const [error, setError] = useState('');

            const handleLogin = (e) => {
                e.preventDefault();
                if ((djName === 'Angie' || djName === 'Justin') && password === 'puppies') {
                    onLogin();
                } else {
                    setError('Invalid DJ Name or Password.');
                }
            };

            return (
                <form onSubmit={handleLogin}>
                    {error && <p className="text-red-500 text-center mb-4">{error}</p>}
                    <div className="mb-4">
                        <label htmlFor="dj-name" className="block text-cyan-300 text-sm font-bold mb-2">DJ Name</label>
                        <select id="dj-name" value={djName} onChange={e => setDjName(e.target.value)} required className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600">
                            <option value="">Select DJ</option>
                            <option value="Angie">Angie</option>
                            <option value="Justin">Justin</option>
                        </select>
                    </div>
                    <div className="mb-4">
                        <label htmlFor="dj-password" className="block text-cyan-300 text-sm font-bold mb-2">Password</label>
                        <input type="password" id="dj-password" value={password} onChange={e => setPassword(e.target.value)} required className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600" />
                    </div>
                    <button type="submit" className="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg w-full">Login</button>
                </form>
            );
        };

        const QueueList = ({ queue, isDjView, onReorder, onEdit, onDelete, onMove, onMarkAsPlayed, title, isUpcomingQueue, onVote, votedSongs = [] }) => {
            const dragItem = useRef(null);
            const dragOverItem = useRef(null);

            const handleDragStart = (e, index) => {
                dragItem.current = index;
                e.dataTransfer.effectAllowed = 'move';
            };
            const handleDragEnter = (e, index) => { dragOverItem.current = index; };
            const handleDragEnd = () => {
                if (dragItem.current !== null && dragOverItem.current !== null && dragItem.current !== dragOverItem.current) {
                    onReorder(dragItem.current, dragOverItem.current);
                }
                dragItem.current = null;
                dragOverItem.current = null;
            };
            
            if (queue.length === 0) {
                return <div className="text-center text-gray-400 py-8">The {title.toLowerCase()} is currently empty.</div>
            }

            return (
                <div className="space-y-3">
                    {queue.map((item, index) => {
                        const isNowPlaying = isUpcomingQueue && index === 0;
                        const totalVotes = (item.likes?.length || 0) + (item.dislikes?.length || 0);
                        const likePercentage = totalVotes > 0 ? Math.round(((item.likes?.length || 0) / totalVotes) * 100) : null;
                        const canVote = !isDjView && item.type === 'song' && (isNowPlaying || item.played);
                        const currentVote = votedSongs.find(v => v.id === item.id)?.vote;

                        const itemContent = (
                            <div 
                                className={`flex items-center gap-4 p-3 rounded-lg shadow-md transition-all 
                                    ${item.type === 'event' ? 'bg-pink-600' : 'bg-gray-700'} 
                                    ${item.played ? 'opacity-50' : ''}
                                    ${isDjView && !item.played ? 'cursor-move' : ''}`}
                                draggable={isDjView && !item.played}
                                onDragStart={(e) => handleDragStart(e, index)}
                                onDragEnter={(e) => handleDragEnter(e, index)}
                                onDragEnd={handleDragEnd}
                                onDragOver={(e) => e.preventDefault()}
                            >
                                <div className="text-2xl font-bold text-cyan-300 w-8 text-center">{index + 1}</div>
                                <div className="w-12 h-12 bg-gray-800 rounded-md flex items-center justify-center text-3xl text-gray-500">🎵</div>
                                <div className="flex-grow">
                                    <p className={`font-bold text-lg ${item.type === 'event' ? 'text-white' : 'text-cyan-300'}`}>{item.danceName}</p>
                                    <p className={`text-sm ${item.type === 'event' ? 'text-pink-200' : 'text-gray-300'}`}>{item.songName}</p>
                                    <p className="text-xs text-gray-400">{item.artist}</p>
                                </div>
                                {canVote && (
                                    <div className="flex gap-2">
                                        <button onClick={() => onVote(item.id, 'like')} className={`rating-button text-2xl ${currentVote === 'like' ? 'selected' : ''}`}>👍</button>
                                        <button onClick={() => onVote(item.id, 'dislike')} className={`rating-button text-2xl ${currentVote === 'dislike' ? 'selected' : ''}`}>👎</button>
                                    </div>
                                )}
                                {isDjView && (
                                    <div className="flex flex-col md:flex-row items-center gap-2">
                                        {likePercentage !== null && <div className="text-sm font-bold text-green-400">{likePercentage}% 👍</div>}
                                        {!item.played && (
                                            <button onClick={() => onMarkAsPlayed(item.id)} className="text-green-400 hover:text-green-300 p-1 rounded-full neon-checkmark" title="Mark as Played">
                                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth={2}>
                                                    <path strokeLinecap="round" strokeLinejoin="round" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                                </svg>
                                            </button>
                                        )}
                                        <div className="flex flex-col">
                                            <button onClick={() => onMove(index, 'up')} className="text-gray-300 hover:text-white" disabled={item.played}>▲</button>
                                            <button onClick={() => onMove(index, 'down')} className="text-gray-300 hover:text-white" disabled={item.played}>▼</button>
                                        </div>
                                        <button onClick={() => onEdit(item)} className="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-1 px-2 rounded text-xs">Edit</button>
                                        <button onClick={() => onDelete(item.id)} className="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-2 rounded text-xs">Delete</button>
                                    </div>
                                )}
                            </div>
                        );

                        if (isNowPlaying) {
                            return (
                                <div key={item.id} className="border-2 border-cyan-400 rounded-lg p-2 now-playing-glow">
                                    <p className="text-center font-bold text-cyan-300 text-sm animate-pulse pb-2">NOW PLAYING</p>
                                    {itemContent}
                                </div>
                            );
                        }

                        return <div key={item.id}>{itemContent}</div>;
                    })}
                </div>
            );
        };

        const EditQueueItemModal = ({ item, onSave, onClose }) => {
            const [danceName, setDanceName] = useState(item.danceName);
            const [songName, setSongName] = useState(item.songName);
            const [artist, setArtist] = useState(item.artist);

            const handleSave = (e) => {
                e.preventDefault();
                onSave({ ...item, danceName, songName, artist });
            };

            return (
                <Modal show={true} onClose={onClose} title="Edit Queue Item">
                    <form onSubmit={handleSave}>
                        <div className="mb-4">
                            <label htmlFor="edit-dance-name" className="block text-cyan-300 text-sm font-bold mb-2">Dance Name/Style</label>
                            <input type="text" id="edit-dance-name" value={danceName} onChange={e => setDanceName(e.target.value)} required className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600" />
                        </div>
                        <div className="mb-4">
                            <label htmlFor="edit-song-name" className="block text-cyan-300 text-sm font-bold mb-2">Song/Event Info</label>
                            <input type="text" id="edit-song-name" value={songName} onChange={e => setSongName(e.target.value)} required className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600" />
                        </div>
                        <div className="mb-4">
                            <label htmlFor="edit-artist-name" className="block text-cyan-300 text-sm font-bold mb-2">Artist</label>
                            <input type="text" id="edit-artist-name" value={artist} onChange={e => setArtist(e.target.value)} className="shadow appearance-none border rounded w-full py-2 px-3 bg-gray-700 text-white leading-tight focus:outline-none focus:shadow-outline border-gray-600" />
                        </div>
                        <button type="submit" className="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg w-full">Save Changes</button>
                    </form>
                </Modal>
            );
        };

        const App = () => {
            const [isDjLoggedIn, setIsDjLoggedIn] = useState(false);
            const [queue, setQueue] = useState([]);
            const [requests, setRequests] = useState([]);
            const [tippingInfo, setTippingInfo] = useState({ venmo: '', cashapp: '' });
            const [showLineRequestModal, setShowLineRequestModal] = useState(false);
            const [showPartnerRequestModal, setShowPartnerRequestModal] = useState(false);
            const [showLoginModal, setShowLoginModal] = useState(false);
            const [showLineDanceLessonModal, setShowLineDanceLessonModal] = useState(false);
            const [editingItem, setEditingItem] = useState(null);
            const [venmoUser, setVenmoUser] = useState('');
            const [cashappUser, setCashappUser] = useState('');
            const [tipSaveConfirm, setTipSaveConfirm] = useState(false);
            const [confirmState, setConfirmState] = useState({ show: false, title: '', message: '', onConfirm: () => {} });
            const [promptState, setPromptState] = useState({ show: false, title: '', message: '', onConfirm: () => {} });
            const [showDjHistory, setShowDjHistory] = useState(false);
            const [searchTerm, setSearchTerm] = useState('');
            const [votedSongs, setVotedSongs] = useState(() => {
                const saved = localStorage.getItem('votedSongs');
                return saved ? JSON.parse(saved) : [];
            });
            const [userId, setUserId] = useState(() => {
                let id = localStorage.getItem('neonBootsUserId');
                if (!id) {
                    id = Math.random().toString(36).substring(2, 15);
                    localStorage.setItem('neonBootsUserId', id);
                }
                return id;
            });

            useEffect(() => {
                localStorage.setItem('votedSongs', JSON.stringify(votedSongs));
            }, [votedSongs]);

            useEffect(() => {
                if (!db) {
                    console.log("Firestore not initialized, skipping data fetch.");
                    return;
                }
                seedInitialData();
                const queueQuery = db.collection("queue").orderBy("order");
                const unsubscribeQueue = queueQuery.onSnapshot(snapshot => {
                    const queueData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    queueData.sort((a, b) => {
                        if (a.played && !b.played) return 1;
                        if (!a.played && b.played) return -1;
                        return a.order - b.order;
                    });
                    setQueue(queueData);
                });

                const requestsQuery = db.collection("requests").orderBy("createdAt", "desc");
                const unsubscribeRequests = requestsQuery.onSnapshot(snapshot => {
                    setRequests(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
                });
                
                const tippingDoc = db.collection("settings").doc("tipping");
                const unsubscribeTipping = tippingDoc.onSnapshot(doc => {
                    if (doc.exists) {
                        const data = doc.data();
                        setTippingInfo(data); setVenmoUser(data.venmo || ''); setCashappUser(data.cashapp || '');
                    }
                });
                return () => { unsubscribeQueue(); unsubscribeRequests(); unsubscribeTipping(); };
            }, []);

            const handleAddRequestToQueue = async (request, position) => {
                if (!db) return;
                const upcomingQueue = queue.filter(q => !q.played);
                const batch = db.batch();

                if (position === 'next') {
                    const newOrderIndex = 1; // Position #2
                    upcomingQueue.forEach(item => {
                        if (item.order >= newOrderIndex) {
                            batch.update(db.collection('queue').doc(item.id), { order: item.order + 1 });
                        }
                    });
                    const newDocRef = db.collection('queue').doc();
                    batch.set(newDocRef, { type: 'song', danceName: request.danceName, songName: request.songName, artist: request.artist, order: newOrderIndex, played: false, likes: [], dislikes: [] });
                } else { // 'last'
                    const newOrderIndex = upcomingQueue.length;
                    const newDocRef = db.collection('queue').doc();
                    batch.set(newDocRef, { type: 'song', danceName: request.danceName, songName: request.songName, artist: request.artist, order: newOrderIndex, played: false, likes: [], dislikes: [] });
                }
                
                batch.delete(db.collection('requests').doc(request.id));
                await batch.commit();
            };

            const handleDeleteRequest = async (id) => { if (!db) return; await db.collection('requests').doc(id).delete(); };

            const handleAddEventToQueue = (eventName, notes = '') => {
                setPromptState({
                    show: true,
                    title: `Add Event: ${eventName}`,
                    message: 'Enter any optional notes for this event.',
                    onConfirm: async (noteInput) => {
                        if (!db) return;
                        const upcomingQueue = queue.filter(q => !q.played);
                        await db.collection('queue').add({ type: 'event', danceName: eventName, songName: notes || noteInput, artist: '', order: upcomingQueue.length, played: false, likes: [], dislikes: [] });
                        setPromptState({ show: false, title: '', message: '', onConfirm: () => {} });
                    }
                });
            };

            const handleAddLineDanceLesson = async (danceName) => {
                if (!db) return;
                const upcomingQueue = queue.filter(q => !q.played);
                await db.collection('queue').add({ type: 'event', danceName: 'Line Dance Lesson', songName: `Teaching: ${danceName}`, artist: '', order: upcomingQueue.length, played: false, likes: [], dislikes: [] });
                setShowLineDanceLessonModal(false);
            };

            const handleSaveTippingInfo = async (e) => {
                e.preventDefault();
                if (!db) return;
                const tipRef = db.collection("settings").doc("tipping");
                await tipRef.set({ venmo: venmoUser, cashapp: cashappUser }, { merge: true });
                setTipSaveConfirm(true);
                setTimeout(() => setTipSaveConfirm(false), 2000);
            };
            
            const handleQueueReorder = useCallback(async (dragIndex, dropIndex) => {
                if (!db) return;
                const upcomingQueue = queue.filter(item => !item.played);
                const newQueue = [...upcomingQueue];
                const [draggedItem] = newQueue.splice(dragIndex, 1);
                newQueue.splice(dropIndex, 0, draggedItem);
                const batch = db.batch();
                newQueue.forEach((item, index) => batch.update(db.collection('queue').doc(item.id), { order: index }));
                await batch.commit();
            }, [queue]);

            const handleMoveQueueItem = (index, direction) => {
                const upcomingQueue = queue.filter(item => !item.played);
                if (direction === 'up' && index > 0) handleQueueReorder(index, index - 1);
                else if (direction === 'down' && index < upcomingQueue.length - 1) handleQueueReorder(index, index + 1);
            };
            
            const handleSaveEditedItem = async (updatedItem) => {
                if (!db) return;
                const { id, ...data } = updatedItem;
                await db.collection('queue').doc(id).update(data);
                setEditingItem(null);
            };

            const handleMarkAsPlayed = async (id) => {
                if (!db) return;
                await db.collection('queue').doc(id).update({ played: true });
            };

            const handleDeleteQueueItem = (id) => {
                setConfirmState({
                    show: true,
                    title: 'Delete Item',
                    message: 'Are you sure you want to permanently delete this item from the queue?',
                    onConfirm: async () => {
                        if (!db) return;
                        const itemToDelete = queue.find(item => item.id === id);
                        if (!itemToDelete) return;
                        const batch = db.batch();
                        batch.delete(db.collection('queue').doc(id));
                        
                        const upcomingQueue = queue.filter(q => !q.played && q.id !== id);
                        upcomingQueue.forEach((item, index) => {
                            if (item.order > itemToDelete.order) {
                                batch.update(db.collection('queue').doc(item.id), { order: item.order - 1 });
                            }
                        });

                        await batch.commit();
                        setConfirmState({ show: false, title: '', message: '', onConfirm: () => {} });
                    }
                });
            };

            const handleVote = async (songId, voteType) => {
                if (!db) return;
                const songRef = db.collection('queue').doc(songId);
                const existingVote = votedSongs.find(v => v.id === songId);
                const batch = db.batch();
                let newVotedSongs = [...votedSongs];

                if (existingVote) {
                    const oldVoteType = existingVote.vote;
                    const oldField = oldVoteType === 'like' ? 'likes' : 'dislikes';
                    batch.update(songRef, { [oldField]: firebase.firestore.FieldValue.arrayRemove(userId) });
                    newVotedSongs = newVotedSongs.filter(v => v.id !== songId);

                    if (voteType !== oldVoteType) {
                        const newField = voteType === 'like' ? 'likes' : 'dislikes';
                        batch.update(songRef, { [newField]: firebase.firestore.FieldValue.arrayUnion(userId) });
                        newVotedSongs.push({ id: songId, vote: voteType });
                    }
                } else {
                    const newField = voteType === 'like' ? 'likes' : 'dislikes';
                    batch.update(songRef, { [newField]: firebase.firestore.FieldValue.arrayUnion(userId) });
                    newVotedSongs.push({ id: songId, vote: voteType });
                }

                await batch.commit();
                setVotedSongs(newVotedSongs);
            };

            const handleLoginSuccess = () => {
                setIsDjLoggedIn(true);
                setShowLoginModal(false);
            };

            const upcomingQueue = queue.filter(item => !item.played);
            const recentlyPlayedQueue = queue.filter(item => item.played);
            const filteredRequests = requests.filter(req => 
                req.songName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                req.artist.toLowerCase().includes(searchTerm.toLowerCase()) ||
                req.danceName.toLowerCase().includes(searchTerm.toLowerCase()) ||
                req.customerName.toLowerCase().includes(searchTerm.toLowerCase())
            );

            if (!db) {
                return (
                    <div className="bg-gray-900 text-white min-h-screen flex flex-col justify-center items-center">
                        <h1 className="text-3xl text-red-500">Firebase Not Configured</h1>
                        <p className="mt-4">This app requires a Firebase configuration to run.</p>
                    </div>
                );
            }

            if (isDjLoggedIn) {
                return (
                    <div className="bg-gray-900 text-white min-h-screen p-4 md:p-8">
                        {editingItem && <EditQueueItemModal item={editingItem} onSave={handleSaveEditedItem} onClose={() => setEditingItem(null)} />}
                        <ConfirmModal {...confirmState} onClose={() => setConfirmState({ ...confirmState, show: false })} />
                        <PromptModal {...promptState} onClose={() => setPromptState({ ...promptState, show: false })} />
                        <LineDanceLessonModal show={showLineDanceLessonModal} onClose={() => setShowLineDanceLessonModal(false)} onConfirm={handleAddLineDanceLesson} />

                        <header className="flex justify-between items-center mb-6 pb-4 border-b-2 border-cyan-400">
                            <h1 className="text-3xl md:text-4xl font-bold text-cyan-400">DJ Console</h1>
                            <button onClick={() => setIsDjLoggedIn(false)} className="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-4 rounded-lg">Logout</button>
                        </header>
                        <div className="flex flex-col lg:flex-row gap-8">
                            <div className="lg:w-1/2 flex flex-col gap-6">
                                <div>
                                    <h3 className="text-2xl font-semibold text-pink-400 mb-3">Common Events</h3>
                                    <div className="grid grid-cols-2 gap-3">
                                        <button onClick={() => setShowLineDanceLessonModal(true)} className="bg-gray-700 hover:bg-gray-600 text-cyan-300 font-semibold p-3 rounded-lg text-center">Line Dance Lesson</button>
                                        {['Line Dance', 'Country Partner', 'West Coast', 'Couples Dance', 'Last Call', 'Closing Time'].map(event => (
                                            <button key={event} onClick={() => handleAddEventToQueue(event)} className="bg-gray-700 hover:bg-gray-600 text-cyan-300 font-semibold p-3 rounded-lg text-center">{event}</button>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <h3 className="text-2xl font-semibold text-pink-400 mb-3">Submitted Requests ({filteredRequests.length})</h3>
                                    <input 
                                        type="text"
                                        placeholder="Search by song, artist, dance, or name..."
                                        value={searchTerm}
                                        onChange={e => setSearchTerm(e.target.value)}
                                        className="w-full p-2 mb-3 bg-gray-700 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-400"
                                    />
                                    <div className="bg-gray-800 p-4 rounded-lg max-h-96 overflow-y-auto space-y-3">
                                        {filteredRequests.length > 0 ? filteredRequests.map(req => (
                                            <div key={req.id} className="bg-gray-700 p-3 rounded-lg">
                                                <p><span className="font-bold text-cyan-300">{req.danceName}</span> - <span className="text-gray-300">{req.songName}</span> by <span className="italic text-gray-400">{req.artist}</span></p>
                                                <p className="text-sm text-gray-500">From: {req.customerName}</p>
                                                {req.spotifyLink && <a href={req.spotifyLink} target="_blank" rel="noopener noreferrer" className="text-green-400 text-sm hover:underline">Spotify Link</a>}
                                                <div className="flex gap-2 mt-2">
                                                    <button onClick={() => handleAddRequestToQueue(req, 'next')} className="bg-green-600 hover:bg-green-700 text-white text-xs font-bold py-1 px-2 rounded">Add Next</button>
                                                    <button onClick={() => handleAddRequestToQueue(req, 'last')} className="bg-blue-600 hover:bg-blue-700 text-white text-xs font-bold py-1 px-2 rounded">Add Last</button>
                                                    <button onClick={() => handleDeleteRequest(req.id)} className="bg-red-600 hover:bg-red-700 text-white text-xs font-bold py-1 px-2 rounded">Delete</button>
                                                </div>
                                            </div>
                                        )) : <p className="text-gray-400">No matching requests.</p>}
                                    </div>
                                </div>
                                <div>
                                    <h3 className="text-2xl font-semibold text-pink-400 mb-3">Tipping Links</h3>
                                    <form onSubmit={handleSaveTippingInfo} className="bg-gray-800 p-4 rounded-lg space-y-3">
                                        <input type="text" value={venmoUser} onChange={e => setVenmoUser(e.target.value)} placeholder="Venmo Username" className="w-full p-2 bg-gray-700 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-400" />
                                        <input type="text" value={cashappUser} onChange={e => setCashappUser(e.target.value)} placeholder="Cash App $Cashtag" className="w-full p-2 bg-gray-700 rounded border border-gray-600 focus:outline-none focus:ring-2 focus:ring-cyan-400" />
                                        <div className="flex items-center gap-4">
                                            <button type="submit" className="bg-cyan-500 hover:bg-cyan-600 text-gray-900 font-bold py-2 px-4 rounded-lg">Save Tips</button>
                                            {tipSaveConfirm && <span className="text-green-400 text-2xl">✔️</span>}
                                        </div>
                                    </form>
                                </div>
                            </div>
                            <div className="lg:w-1/2">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="text-2xl font-semibold text-pink-400">{showDjHistory ? 'Played History' : 'Live Dance Queue'}</h3>
                                    <button onClick={() => setShowDjHistory(!showDjHistory)} className="bg-gray-700 hover:bg-gray-600 text-cyan-300 font-semibold py-1 px-3 rounded-lg text-sm">
                                        {showDjHistory ? 'View Queue' : 'View History'}
                                    </button>
                                </div>
                                <div className="bg-gray-800 p-4 rounded-lg min-h-[50vh]">
                                    {showDjHistory ? (
                                        <QueueList queue={recentlyPlayedQueue} isDjView={true} title="History" />
                                    ) : (
                                        <QueueList queue={upcomingQueue} isDjView={true} onReorder={handleQueueReorder} onEdit={setEditingItem} onDelete={handleDeleteQueueItem} onMove={handleMoveQueueItem} onMarkAsPlayed={handleMarkAsPlayed} title="Queue" isUpcomingQueue={true} />
                                    )}
                                </div>
                            </div>
                        </div>
                    </div>
                );
            }

            return (
                <div className="container mx-auto p-4 md:p-8">
                    <Modal show={showLineRequestModal} onClose={() => setShowLineRequestModal(false)} title="Request a Line Dance">
                        <RequestForm onClose={() => setShowLineRequestModal(false)} tippingInfo={tippingInfo} formType="line" />
                    </Modal>
                    <Modal show={showPartnerRequestModal} onClose={() => setShowPartnerRequestModal(false)} title="Request a Partner Dance">
                        <RequestForm onClose={() => setShowPartnerRequestModal(false)} tippingInfo={tippingInfo} formType="partner" />
                    </Modal>
                    <Modal show={showLoginModal} onClose={() => setShowLoginModal(false)} title="DJ Login">
                        <DJLogin onLogin={handleLoginSuccess} />
                    </Modal>
                    <header className="text-center mb-8">
                        <h1 className="text-7xl md:text-8xl font-neon" style={{ color: '#ff00ff' }}>
                            Neon Boots
                        </h1>
                        <p className="text-cyan-300 text-lg mt-2">Houston's Premier Country & Western Dance Club</p>
                        <div className="flex justify-center gap-4 mt-6">
                            <a href="https://www.neonbootsclub.com/" target="_blank" rel="noopener noreferrer" className="bg-transparent border-2 border-cyan-400 text-cyan-400 hover:bg-cyan-400 hover:text-gray-900 font-bold py-2 px-6 rounded-lg transition-colors">
                                Visit Website
                            </a>
                            <button onClick={() => setShowLineRequestModal(true)} className="bg-pink-500 hover:bg-pink-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                                Request Line Dance
                            </button>
                            <button onClick={() => setShowPartnerRequestModal(true)} className="bg-cyan-500 hover:bg-cyan-600 text-white font-bold py-2 px-6 rounded-lg transition-colors">
                                Request Partner Dance
                            </button>
                        </div>
                    </header>
                    <main>
                        <h2 className="text-3xl font-bold text-center text-cyan-400 mb-4">Live Dance Queue</h2>
                        <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                            <QueueList queue={upcomingQueue} isDjView={false} title="Queue" isUpcomingQueue={true} onVote={handleVote} votedSongs={votedSongs} />
                        </div>

                        {recentlyPlayedQueue.length > 0 && (
                            <div className="mt-12">
                                <h2 className="text-3xl font-bold text-center text-cyan-400 mb-4">Recently Played</h2>
                                <div className="bg-gray-800 p-4 rounded-lg shadow-lg">
                                    <QueueList queue={recentlyPlayedQueue} isDjView={false} title="Recently Played" onVote={handleVote} votedSongs={votedSongs} />
                                </div>
                                <TippingSection tippingInfo={tippingInfo} />
                            </div>
                        )}
                    </main>
                    <footer className="text-center mt-8 pt-4 border-t border-gray-700">
                        <button onClick={() => setShowLoginModal(true)} className="text-gray-500 hover:text-cyan-300 transition-colors">
                            DJ Login
                        </button>
                    </footer>
                </div>
            );
        };

        // Render the main App component into the 'root' div
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
